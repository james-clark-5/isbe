
load('C:\isbe\nailfold\data\rsa_study\data_lists\image_id_data.mat');
num_images = length(image_id_data.im_names);
miccai_selection.validation = false(num_images,1);
miccai_selection.test = false(num_images,1);

hc_in_val = 0;
pr_in_val = 0;
ss_in_val = 0;
for i_im = 1:num_images
    
    num_marks = length(unique(image_id_data.marker_idx{i_im}));
    
    if num_marks > 1 && ~image_id_data.dataset_idx.training(i_im)
    
        switch image_id_data.category{i_im}
            case 'S'
                if ss_in_val
                    miccai_selection.test(i_im) = 1;
                    ss_in_val = 0;
                else
                    miccai_selection.validation(i_im) = 1;
                    ss_in_val = 1;
                end
            case 'HC'
                if hc_in_val
                    miccai_selection.test(i_im) = 1;
                    hc_in_val = 0;
                else
                    miccai_selection.validation(i_im) = 1;
                    hc_in_val = 1;
                end
            case 'P'
                if pr_in_val
                    miccai_selection.test(i_im) = 1;
                    pr_in_val = 0;
                else
                    miccai_selection.validation(i_im) = 1;
                    pr_in_val = 1;
                end
        end
    end
end
    
save('C:\isbe\nailfold\data\rsa_study\data_lists\miccai_lists.mat', 'miccai_selection');
%%
%--------------------------------------------------------------------------
%Get local maxima from the apex offset maps
load('C:\isbe\nailfold\data\rsa_study\data_lists\image_id_data.mat');
load('C:\isbe\nailfold\data\rsa_study\data_lists\miccai_lists.mat', 'miccai_selection');
extract_apex_map_maxima( ... % the user's input
    'image_names',          image_id_data.im_names(miccai_selection.validation | miccai_selection.test),...
    'data_dir',             [nailfoldroot 'data/rsa_study/master_set/'],...
    'fov_mask_dir',         'fov_masks',...
    'centre_dir',           'vessel_centres\full_centres',...
    'apex_map_dir',         'apex_maps\set12g_half_296655',...
    'candidates_dir',       'apex_maps\set12g_half_296655\miccai_maxima',...
    'exclusion_zone',       20,...
    'transform_scores',     1,...
    'apex_class_thresh',    0.5,...
    'discard_pts',          1,...
    'base_width',           20,...
    'overwrite',            0);
%%
%--------------------------------------------------------------------------
%%
compute_apex_candidate_hogs( ... % the user's input
    'image_names',          image_id_data.im_names(miccai_selection.validation | miccai_selection.test),...
    'data_dir',             [nailfoldroot 'data/rsa_study/master_set/'],...
    'feature_im_dir',       'images',...
    'ori_dir',              'rf_regression/296621/',...
    'width_dir',            'rf_regression/297037/',...
    'candidates_dir',       'apex_maps\set12g_half_296655\miccai_maxima',...
    'hog_dir',              'apex_maps\set12g_half_296655\miccai_maxima\hogs\',...
    'feature_sigma',        0,...
    'prob_sigma',           2,...
    'ori_sigma',            0,...
    'width_sigma',          2,...
    'num_cells',            8,...
    'cell_sz',              8,... %Size of HoG cells in blocks
    'block_sz',             [2 2],...%Size of blocks in cells
    'num_ori_bins',         12,... %Number of bins in orientation histograms
    'norm_method',          'l1-sqrt',... %Method for local normalisation
    'block_spacing',        8,... %Separation between blocks in pixels - controls level of overlap
    'gradient_operator',    [-1 0 1],...
    'spatial_sigma',        0, ...
    'angle_wrap',           1,...
    'base_width',           20, ...
    'dist_thresh',          24^2,...
    'overwrite',            0);
%%
extract_apex_candidate_class( ... % the user's input
    'image_names',          image_id_data.im_names(miccai_selection.validation),...
    'data_dir',             [nailfoldroot 'data/rsa_study/master_set/'],...
    'prob_dir',             'rf_classification/296655/',...
    'candidates_dir',       'apex_maps\set12g_half_296655\miccai_maxima',...
    'apex_gt_dir',          'apex_gt',...
    'label_dir',            'apex_maps\set12g_half_296655\miccai_maxima\labels',...
    'prob_sigma',           2,...
    'overwrite',            0);
%%
load('C:\isbe\nailfold\data\rsa_study\data_lists\miccai_lists.mat', 'miccai_selection');
im_names = image_id_data.im_names(miccai_selection.validation);
train_hog_apex_rescorer(... % the user's input
    'image_names',          im_names(1:228),...
    'data_path',            [],...
    'data_dir',             [nailfoldroot 'data/rsa_study/master_set/'],...
    'model_id',             'ims_1_228',...
    'model_root',           [unixenv('DATA_ROOT',[]) unixenv('MODEL_ROOT',[nailfoldroot,'models/apex'])], ...
    'model_name',           'rf',...
    'num_trees',            unixenv('NUM_TREES',100), ...
    'labels_dir',           'apex_maps\set12g_half_296655\miccai_maxima\labels',...
    'hog_dir',              'apex_maps\set12g_half_296655\miccai_maxima\hogs',...
    'save_data',            0);
%%
train_hog_apex_rescorer(... % the user's input
    'image_names',          im_names(229:456),...
    'data_path',            [],...
    'data_dir',             [nailfoldroot 'data/rsa_study/master_set/'],...
    'model_id',             'ims_229_456',...
    'model_root',           [unixenv('DATA_ROOT',[]) unixenv('MODEL_ROOT',[nailfoldroot,'models/apex'])], ...
    'model_name',           'rf',...
    'num_trees',            unixenv('NUM_TREES',100), ...
    'labels_dir',           'apex_maps\set12g_half_296655\miccai_maxima\labels',...
    'hog_dir',              'apex_maps\set12g_half_296655\miccai_maxima\hogs',...
    'save_data',            0);
%%
train_hog_apex_rescorer(... % the user's input
    'image_names',          im_names,...
    'data_path',            [],...
    'data_dir',             [nailfoldroot 'data/rsa_study/master_set/'],...
    'model_id',             'miccai_all',...
    'model_root',           [unixenv('DATA_ROOT',[]) unixenv('MODEL_ROOT',[nailfoldroot,'models/apex'])], ...
    'model_name',           'rf',...
    'num_trees',            unixenv('NUM_TREES',100), ...
    'labels_dir',           'apex_maps\set12g_half_296655\miccai_maxima\labels',...
    'hog_dir',              'apex_maps\set12g_half_296655\miccai_maxima\hogs',...
    'save_data',            0);
%%
load('C:\isbe\nailfold\data\rsa_study\data_lists\miccai_lists.mat', 'miccai_selection');
im_names = image_id_data.im_names(miccai_selection.validation);
rf = u_load('C:\isbe\nailfold\models\apex\rescoring\ims_1_228\rf.mat');
predict_apex_candidate_rescore(...
    'image_names',          im_names(229:456),...
    'apex_class_rf',        rf,...
    'data_dir',             [nailfoldroot 'data/rsa_study/master_set/'],...
    'candidates_dir',       'apex_maps\set12g_half_296655\miccai_maxima',...
    'rescore_dir',          'apex_maps\set12g_half_296655\miccai_maxima\rescores',...
    'hog_dir',              'apex_maps\set12g_half_296655\miccai_maxima\hogs');

rf = u_load('C:\isbe\nailfold\models\apex\rescoring\ims_229_456\rf.mat');
predict_apex_candidate_rescore(...
    'image_names',          im_names(1:228),...
    'apex_class_rf',        rf,...
    'data_dir',             [nailfoldroot 'data/rsa_study/master_set/'],...
    'candidates_dir',       'apex_maps\set12g_half_296655\miccai_maxima',...
    'rescore_dir',          'apex_maps\set12g_half_296655\miccai_maxima\rescores',...
    'hog_dir',              'apex_maps\set12g_half_296655\miccai_maxima\hogs');
%
compute_apex_candidate_displacements(...
    'image_names', im_names,...
    'data_dir', [nailfoldroot 'data/rsa_study/master_set/'],...
    'vessel_centre_dir', 'vessel_centres\full_centres',...
    'displacement_dir', 'apex_maps\set12g_half_296655\miccai_maxima\displacements',...
    'candidates_dir', 'apex_maps\set12g_half_296655\miccai_maxima\rescores',...
    'min_candidates', 3,...
    'initial_thresh', 0.3,...
    'grid_spacing', 8);
%%
rf = u_load('C:\isbe\nailfold\models\apex\rescoring\miccai_all\rf.mat');
predict_apex_candidate_rescore(...
    'image_names',          image_id_data.im_names(miccai_selection.test),...
    'apex_class_rf',        rf,...
    'data_dir',             [nailfoldroot 'data/rsa_study/master_set/'],...
    'candidates_dir',       'apex_maps\set12g_half_296655\miccai_maxima',...
    'rescore_dir',          'apex_maps\set12g_half_296655\miccai_maxima\rescores',...
    'hog_dir',              'apex_maps\set12g_half_296655\miccai_maxima\hogs');

compute_apex_candidate_displacements(...
    'image_names', image_id_data.im_names(miccai_selection.test),...
    'data_dir', [nailfoldroot 'data/rsa_study/master_set/'],...
    'vessel_centre_dir', 'vessel_centres\full_centres',...
    'displacement_dir', 'apex_maps\set12g_half_296655\miccai_maxima\displacements',...
    'candidates_dir', 'apex_maps\set12g_half_296655\miccai_maxima\rescores',...
    'min_candidates', 3,...
    'initial_thresh', 0.3,...
    'grid_spacing', 8);

%%
make_apex_candidate_class_probs(...
    'image_names',          image_id_data.im_names(miccai_selection.validation),...
    'model_id',             'miccai_class_MAP',...
    'model_root',           [nailfoldroot,'models/apex'], ...
    'model_name',           'class_map',...
    'data_dir',             [nailfoldroot 'data/rsa_study/master_set/'],...
    'displacement_dir',     'apex_maps\set12g_half_296655\miccai_maxima\displacements',...
    'candidates_dir',       'apex_maps\set12g_half_296655\miccai_maxima\rescores',...
    'label_dir',            'apex_maps\set12g_half_296655\miccai_maxima\labels',...
    'plot',                 1,...
    'fig_dir',              []);
%%
load([nailfoldroot,'models/apex/final_MAP/miccai_class_MAP/class_map.mat']);
select_vessels_from_candidates( ...
    'image_names',          image_id_data.im_names(miccai_selection.validation),...
    'class_map',            class_map,...
    'selected_dir',         'apex_maps\set12g_half_296655\miccai_maxima\selected_apexes',...
    'displacement_dir',     'apex_maps\set12g_half_296655\miccai_maxima\displacements',...
    'rescore_dir',          'apex_maps\set12g_half_296655\miccai_maxima\rescores',...
    'strong_vessel_thresh', 0.8,...
    'angle_discard_thresh', 75*pi/180,...
    'do_final_cull',        1);
%
select_vessels_from_candidates( ...
    'image_names',          image_id_data.im_names(miccai_selection.test),...
    'class_map',            class_map,...
    'selected_dir',         'apex_maps\set12g_half_296655\miccai_maxima\selected_apexes',...
    'displacement_dir',     'apex_maps\set12g_half_296655\miccai_maxima\displacements',...
    'rescore_dir',          'apex_maps\set12g_half_296655\miccai_maxima\rescores',...
    'strong_vessel_thresh', 0.8,...
    'angle_discard_thresh', 75*pi/180,...
    'do_final_cull',        1);
%%
extract_apex_measures_set(...
    'image_names',          image_id_data.im_names(miccai_selection.validation),...
    'data_dir',             [nailfoldroot 'data/rsa_study/master_set/'],...
    'image_dir',            'images',...
    'prob_dir',             'rf_classification/296655',...
    'ori_dir',              'rf_regression/296621',...
    'width_dir',            'rf_regression/297037',...
    'candidates_dir',       'apex_maps\set12g_half_296655\miccai_maxima\rescores',...
    'displacements_dir',    'apex_maps\set12g_half_296655\miccai_maxima\displacements',...
    'selected_dir',         'apex_maps\set12g_half_296655\miccai_maxima\selected_apexes',...
    'metrics_dir',          'apex_maps\set12g_half_296655\miccai_maxima\apex_metrics',...
    'width_predictor',      [],...[nailfoldroot 'models/apex/width/rf.mat'],...
    'prob_sigma',           2,...
    'ori_sigma',            0,...
    'width_sigma',          2,...
    'all',                  0,...
    'plot', 0);
%%
extract_apex_measures_set(...
    'image_names',          image_id_data.im_names(miccai_selection.test),...
    'data_dir',             [nailfoldroot 'data/rsa_study/master_set/'],...
    'image_dir',            'images',...
    'prob_dir',             'rf_classification/296655',...
    'ori_dir',              'rf_regression/296621',...
    'width_dir',            'rf_regression/297037',...
    'candidates_dir',       'apex_maps\set12g_half_296655\miccai_maxima\rescores',...
    'displacements_dir',    'apex_maps\set12g_half_296655\miccai_maxima\displacements',...
    'selected_dir',         'apex_maps\set12g_half_296655\miccai_maxima\selected_apexes',...
    'metrics_dir',          'apex_maps\set12g_half_296655\miccai_maxima\apex_metrics',...
    'width_predictor',      [],...[nailfoldroot 'models/apex/width/rf.mat'],...
    'prob_sigma',           2,...
    'ori_sigma',            0,...
    'width_sigma',          2,...
    'all',                  0,...
    'plot', 0);
%%
fig_dir = 'C:\isbe\matlab_code\trunk\papers\2014miccai\figs\';
auto_stats = analyse_extracted_apex_measures([],...auto_stats,...
    'image_names',          image_id_data.im_names(miccai_selection.validation),...
    'image_id_data',        image_id_data,...
    'data_dir',             [nailfoldroot 'data/rsa_study/master_set/'],...
    'vessel_centre_dir',    'vessel_centres\full_centres\',...
    'selected_dir',         'apex_maps\set12g_half_296655\miccai_maxima\selected_apexes',...
    'metrics_dir',          'apex_maps\set12g_half_296655\miccai_maxima\apex_metrics',...
    'do_make_stats',    1,...
    'do_image_plots',   1, ...
    'selected_features', {'inter_capillary_distance','vessel_density', 'median_apex_width', 'median_orientation_entropy'},...
    'do_people_plots',  0,...
    'fig_dir', fig_dir);
%%
%--------------------------------------------------------------------------
im_names = image_id_data.im_names(miccai_selection.validation);
data_dir = [nailfoldroot 'data/rsa_study/master_set/'];
candidates_dir = [data_dir 'apex_maps\set12g_half_296655\miccai_maxima\'];
rescore_dir = [data_dir 'apex_maps\set12g_half_296655\miccai_maxima\rescores\'];
labels_dir = [data_dir 'apex_maps\set12g_half_296655\miccai_maxima\labels\'];
displacement_dir = [data_dir 'apex_maps\set12g_half_296655\miccai_maxima\displacements\'];
hog_dir = [data_dir 'apex_maps\set12g_half_296655\miccai_maxima\hogs\'];

all_candidate_scores = [];
all_candidate_rescores = [];
all_candidate_disp = [];
all_candidate_labels = [];
all_candidate_class = false(0,1);
all_candidate_width = [];

for i_im = 1:length(im_names)
    load([candidates_dir im_names{i_im} '_candidates.mat'], 'candidate_scores');
    load([rescore_dir im_names{i_im} '_candidates.mat'], 'candidate_rescores');
    load([labels_dir im_names{i_im} '_label.mat'], 'candidates_class', 'candidate_labels');
    load([displacement_dir im_names{i_im} '_dis.mat'], 'candidate_displacements');
    load([hog_dir im_names{i_im} '_hog.mat'], 'candidate_widths');
    
    all_candidate_scores = [all_candidate_scores; candidate_scores]; %#ok
    all_candidate_rescores = [all_candidate_rescores; candidate_rescores]; %#ok
    all_candidate_class = [all_candidate_class; candidates_class]; %#ok
    all_candidate_labels = [all_candidate_labels; candidate_labels]; %#ok
    all_candidate_disp = [all_candidate_disp; candidate_displacements]; %#ok
    all_candidate_width = [all_candidate_width; candidate_widths]; %#ok
end
%
[roc_pts_scores auc_scores] = calculate_roc_curve(all_candidate_scores, all_candidate_class, linspace(0,5,1000));
[roc_pts_rescores auc_rescores] = calculate_roc_curve(all_candidate_rescores, all_candidate_class);

figure; axis equal; hold all;
plot(roc_pts_scores(:,1), roc_pts_scores(:,2), '-');
plot(roc_pts_rescores(:,1), roc_pts_rescores(:,2), '-');
axis([0 1 0 1]);
legend({['RF offset scores, A_z = ' num2str(auc_scores,3)], ['RF class rescores, A_z = ' num2str(auc_rescores,3)]},...
    'location', 'southeast');
%%
%--------------------------------------------------------------------------
[co_occurrence_v] = miccai_results_cooc_fun('validation');
[co_occurrence_t a_b_widths a_c_widths b_c_widths] = miccai_results_cooc_fun('test');
results_dir = [nailfoldroot 'data/rsa_study/master_set/apex_maps\set12g_half_296655\miccai_maxima\results\'];
mkdir(results_dir);
save([results_dir 'cooccuurence.mat'], 'co_occurrence_*', 'a_b_widths', 'a_c_widths', 'b_c_widths');
%%
figure; hold all;
plot(sort(abs(diff(a_b_widths,1,2))), linspace(0,1,size(a_b_widths,1)), 'linewidth', 2);
plot(sort(abs(diff(a_c_widths,1,2))), linspace(0,1,size(a_c_widths,1)), 'linewidth', 2);
plot(sort(abs(diff(b_c_widths,1,2))), linspace(0,1,size(b_c_widths,1)), 'linewidth', 2);
legend({'A v B', 'A v C', 'B v C', 'A v D'}, 'location', 'southeast');

a_b_e = sort(abs(diff(a_b_widths,1,2)));
a_c_e = sort(abs(diff(a_c_widths,1,2)));
b_c_e = sort(abs(diff(b_c_widths,1,2)));

for ii = 1:100
    a_b_widths_i = bootstrap_train_data(a_b_widths);
    a_c_widths_i = bootstrap_train_data(a_c_widths);
    b_c_widths_i = bootstrap_train_data(b_c_widths);
    
    plot(sort(abs(diff(a_b_widths_i,1,2))), linspace(0,1,size(a_b_widths,1)), 'b', 'linewidth', 0.5);
    plot(sort(abs(diff(a_c_widths_i,1,2))), linspace(0,1,size(a_c_widths,1)), 'g', 'linewidth', 0.5);
    plot(sort(abs(diff(b_c_widths_i,1,2))), linspace(0,1,size(b_c_widths,1)), 'r', 'linewidth', 0.5);
end
%%
fig_dir = 'C:\isbe\matlab_code\trunk\papers\2014miccai\figs\';

nailfold = u_load('C:\isbe\nailfold\data\rsa_study\master_set\images\10598c.mat');
vessel_prob = u_load('C:\isbe\nailfold\data\rsa_study\master_set\predictions\detection\rf_classification\296655\10598c_pred.mat');
vessel_ori = u_load('C:\isbe\nailfold\data\rsa_study\master_set\predictions\orientation\rf_regression\296621\10598c_pred.mat');
vessel_centre = u_load('C:\isbe\nailfold\data\rsa_study\master_set\vessel_centres\full_centres\10598c_vc.mat');
load('C:\isbe\nailfold\data\rsa_study\master_set\apex_maps\set12g_half_296655\10598c_pred.mat');
load('C:\isbe\nailfold\data\rsa_study\master_set\apex_maps\set12g_half_296655\miccai_maxima\rescores\10598c_candidates.mat');
load('C:\isbe\nailfold\data\rsa_study\master_set\apex_maps\set12g_half_296655\miccai_maxima\selected_apexes\10598c_sel.mat');
load('C:\isbe\nailfold\data\rsa_study\master_set\apex_clusters_merged\10598c_apex_clusters.mat');

initial_thresh = 0.3;
apex_class_thresh = 0.5;

cols = 267:495;
rows = 160:280;
ncols = length(cols);
nrows = length(rows);

vessel_centre.x = vessel_centre.x - cols(1) + 1;
vessel_centre.y = vessel_centre.y - rows(1) + 1;
candidate_xy(:,1) = candidate_xy(:,1) - cols(1) + 1;
candidate_xy(:,2) = candidate_xy(:,2) - rows(1) + 1;

nailfold = nailfold(rows, cols);
vessel_prob = vessel_prob(rows, cols);
vessel_ori = vessel_ori(rows, cols);
apex_offset_map = apex_offset_map(rows,cols);
include_pts = apex_class_pred > apex_class_thresh;

valid_candidates = candidate_rescores > initial_thresh;

xx = 1:ncols;
yy = (1:nrows)';
grid_x = repmat(xx, nrows, 1);
grid_y = repmat(yy, 1, ncols);
   
%Compute weighted kernel estimates of the spatial distribution of
%candidates over this grid
[location_distribution] = build_2d_kernel_distribution(...
   candidate_xy(valid_candidates,:),...
   [grid_x(:) grid_y(:)],...
   candidate_rescores(valid_candidates,:), 0);
   
location_distribution.D_f = reshape(location_distribution.D_f, size(grid_x));
[~, y_max] = max(location_distribution.D_f);
candidate_polyfit = interp1(xx, yy(y_max), candidate_xy(:,1), 'linear');

%%
figure; imgray(vessel_prob);
plot(vessel_centre.x, vessel_centre.y, 'g.', 'markersize', 8);
plot(vessel_centre.x(include_pts), vessel_centre.y(include_pts), 'r.', 'markersize', 10);
axis off;
exportfig_im([fig_dir '01_vessel_prediction.png'], [nrows ncols]);
%
figure; imgray(complex2rgb(vessel_ori));
axis off;
exportfig_im([fig_dir '02_orientation_prediction.png'], [nrows ncols]);
%
figure; imgray(apex_offset_map); colormap(hot(256));
axis off;
exportfig_im([fig_dir '03_apex_heat_map.png'], [nrows ncols]);
%
figure; imgray(location_distribution.D_f);
axis off;
plot(1:length(cols), y_max, 'g--', 'linewidth', 2);
for i_c = 1:length(candidate_rescores)
    if candidate_xy(i_c,1) > 1 && candidate_xy(i_c,1) < ncols &&...
            candidate_xy(i_c,2) > 1 && candidate_xy(i_c,2) < nrows
    plot(candidate_xy(i_c,1), candidate_xy(i_c,2), 'ro', 'markersize', 10*candidate_rescores(i_c));
    plot(...
        [candidate_xy(i_c,1) candidate_xy(i_c,1)],...
        [candidate_xy(i_c,2) candidate_polyfit(i_c)], 'r');
    end
end
exportfig_im([fig_dir '04_apex_location_map.png'], [nrows ncols]);

%%
figure; imgray(nailfold);
axis off;
plot(candidate_xy(selected_distal,1), candidate_xy(selected_distal,2), 'ro', 'markersize', 20, 'MarkerFaceColor', 'r');
plot(candidate_xy(selected_non_distal,1), candidate_xy(selected_non_distal,2), 'ro', 'markersize', 10);
markers = vessels.markers(1:2);

for i_ve = 1:length(vessels.cluster_shapes)

    %Get column index based on observers 1
    idx = find(vessels.cluster_members{i_ve} == markers(1));
    if ~isempty(idx)
        shapes = vessels.cluster_shapes{i_ve};
        cxy = vessels.cluster_xy{i_ve}(idx,:)/2 - [cols(1) rows(1)] + 1;
        if cxy(1) > 1 && cxy(1) < ncols && cxy(2) > 1 && cxy(2) < nrows
            if strcmpi(shapes{idx}, 'NonDistal')
                plot(cxy(:,1), cxy(:,2), 'bs', 'markersize', 10);
            else
                plot(cxy(:,1), cxy(:,2), 'bs', 'markersize', 20, 'MarkerFaceColor', 'b');
            end
        end
    end

    %Get row index based on observer 2
    idx = find(vessels.cluster_members{i_ve} == markers(2));
    if ~isempty(idx)
        shapes = vessels.cluster_shapes{i_ve};
        cxy = vessels.cluster_xy{i_ve}(idx,:)/2 - [cols(1) rows(1)] + 1;
        if cxy(1) > 1 && cxy(1) < ncols && cxy(2) > 1 && cxy(2) < nrows
            if strcmpi(shapes{idx}, 'NonDistal')
                plot(cxy(:,1), cxy(:,2), 'gs', 'markersize', 10);
            else
                plot(cxy(:,1), cxy(:,2), 'gs', 'markersize', 20, 'MarkerFaceColor', 'g');
            end
        end
    end
end
exportfig_im([fig_dir '00_nailfold.png'], [nrows ncols]);
%%
extract_apex_measures_set(...
    'image_names',          {'10598c'},...
    'data_dir',             [nailfoldroot 'data/rsa_study/master_set/'],...
    'image_dir',            'images',...
    'prob_dir',             'rf_classification/296655',...
    'ori_dir',              'rf_regression/296621',...
    'width_dir',            'rf_regression/297037',...
    'candidates_dir',       'apex_maps\set12g_half_296655\miccai_maxima\rescores',...
    'displacements_dir',    'apex_maps\set12g_half_296655\miccai_maxima\displacements',...
    'selected_dir',         'apex_maps\set12g_half_296655\miccai_maxima\selected_apexes',...
    'metrics_dir',          'temp',...
    'width_predictor',      [],...[nailfoldroot 'models/apex/width/rf.mat'],...
    'prob_sigma',           2,...
    'ori_sigma',            0,...
    'width_sigma',          2,...
    'all',                  0,...
    'plot', 0);
%%
load('C:\isbe\nailfold\data\rsa_study\master_set\temp\10598c_am.mat');

figure; imgray(nailfold);
c_xy = candidate_xy(selected_distal,:);

colors = lines(5);
pn = 1;
for i_can = 1:size(c_xy,1)
    if c_xy(i_can,1) > 1 && c_xy(i_can,1) < ncols && c_xy(i_can,2) > 1 && c_xy(i_can,2) < nrows
        
        
        apex_xy = apex_measures.apex_aam_fit(:,:,i_can);
        apex_xy(:,1) = apex_xy(:,1) - cols(1) + 1;
        apex_xy(:,2) = apex_xy(:,2) - rows(1) + 1;
        
        a_theta = angle(apex_measures.base_orientation(i_can)) / 2;
        nx = sin(a_theta);
        ny = cos(a_theta);
        
        apex_width_x = apex_xy(16,1) + apex_measures.width_at_apex(i_can)*[-1 1]*nx/2;
        apex_width_y = apex_xy(16,2) + apex_measures.width_at_apex(i_can)*[-1 1]*ny/2;
        
        plot(apex_xy(:,1), apex_xy(:,2), '--', 'Color', colors(pn,:), 'linewidth', 2);
        plot(apex_width_x, apex_width_y, '-', 'Color', colors(pn,:));
        plot(apex_width_x, apex_width_y, 'o', 'MarkerEdgeColor', colors(pn,:), 'MarkerSize', 10, 'MarkerFaceColor', colors(pn,:));
        
        if pn == 5
            break;
        else
            pn = pn+1;
        end
    end
end
    
axis off;
exportfig_im('K:\isbe\nailfold\capillary_detection_example.png', [nrows ncols]);
%%
load([nailfoldroot,'models/apex/final_MAP/miccai_class_MAP/class_map.mat']);

figure; hold on;
colors = 'rgb';
for i_cl = 1:3
    mesh(class_map.x,  class_map.y,...
        class_map.joint_conditional_probs(:,:,i_cl), 'edgecolor', colors(i_cl));
end
set(gca, 'fontsize', 18);
xlabel('c_i');
ylabel('d_i');
zlabel('p(L_i|c_i&d_i)');
exportfig([fig_dir 'candidate_score_pdf.png']);

figure; hold on;
colors = 'rgb';
for i_cl = 1:3
    mesh(class_map.x,  class_map.y,...
        class_map.joint_conditional_probs(:,:,i_cl), 'edgecolor', colors(i_cl));
end
set(gca, 'fontsize', 18);
xlabel('c_i (Candidate score)');
ylabel('d_i (Candidate displacment)');
zlabel('p(L_i|c_i&d_i)');
exportfig([fig_dir 'candidate_disp_pdf.png']);

im1 = imread([fig_dir 'candidate_score_pdf.png']);
im2 = imread([fig_dir 'candidate_disp_pdf.png']);
im2 = imresize(im2, [size(im1,1) size(im1,2)]);
figure; imgray([im1 im2]);
imwrite([im1 im2], [fig_dir '05_conditional_pdfs.png']);
%%
for im_name = {'10598c', '54611c'}
    nailfold = u_load(['C:\isbe\nailfold\data\rsa_study\master_set\images\' im_name{1} '.mat']);
    mask = u_load(['C:\isbe\nailfold\data\rsa_study\master_set\fov_masks\' im_name{1} '_f_mask.mat']);
    write_im_from_colormap(nailfold, [fig_dir 'nailfold_' im_name{1} '.png'], gray(256),...
        [min(nailfold(mask)) max(nailfold(mask))]);
end





















%--------------------------------------------------------------------------
%--------------------------------------------------------------------------
%%
im_list = dir('C:\isbe\nailfold\data\rsa_study\test_half\images\*.mat');

apex_map_dir = 'C:\isbe\nailfold\data\rsa_study\test_half\apex_maps\miccai_test_set\';
fov_mask_dir = 'C:\isbe\nailfold\data\rsa_study\test_half\fov_masks\';
vessel_centres_dir = 'C:\isbe\nailfold\data\rsa_study\test_half\vessel_centres\full_centres\';

exclsuion_zone = 20;
class_thresh = linspace(0,1,20);
base_width = 20;

%%
candidates_dir = [apex_map_dir 'incremental_maxima\pooled_trees\'];
create_folder(candidates_dir);
for i_im = 1:length(im_list);
    im_name = im_list(i_im).name(1:6);
    display(['Processing image ' num2str(i_im) ', ' datestr(now)]);
    
    load([apex_map_dir im_name '_pred.mat']);
    load([vessel_centres_dir im_name '_vc.mat']);
    f_mask = u_load([fov_mask_dir im_name '_f_mask.mat']);
    
    [discard_pts] = discard_edge_preds(vessel_centre, f_mask);
    include_pts = ~discard_pts;
    
    incremental_apex_offset_preds(apex_class_pred, apex_offset_x_pred, apex_offset_y_pred,...
        vessel_centre, nrows, ncols, include_pts, class_thresh, candidates_dir, im_name, ... % non-strict mode
        'separate_trees',       0,...
        'base_width',           20,...
        'exclsuion_zone',       20,...
        'fov_mask',             f_mask,...
        'plot',                 0);

end
%%
for i_th = 1:20
    candidates_dir_i = [candidates_dir '\thresh' zerostr(i_th,2) '\'];
    
    make_detection_results_struc(...
        'results_name', 'detection_results', ...
        'candidates_dir',    candidates_dir_i,... %mandatory arguments
        'apex_gt_dir', [nailfoldroot 'data/rsa_study/test_half/apex_gt/'],...
        'results_dir', [candidates_dir_i 'results\'],...
        'prob_dir', [nailfoldroot 'data/rsa_study/test_half/predictions/detection/rf_classification/296655/'],...
        'selected_gt', [],...
        'selected_candidates', [],...
        'selected_prob', []);
end
%%
candidates_dir = [apex_map_dir 'incremental_maxima\pooled_trees\'];
for i_ob = 1:2
    figure; hold all; a1 = gca;
    for i_th = 1:20
        candidates_dir_i = [candidates_dir '\thresh' zerostr(i_th,2) '\'];

        [out_stats] = analyse_incremental_rocs(...
            'results_name', 'detection_results',...
            'candidates_dir',    candidates_dir_i,... %mandatory arguments
            'apex_gt_dir', [nailfoldroot 'data/rsa_study/test_half/apex_gt/'],...
            'results_dir', [candidates_dir_i 'results\'],...
            'selected_images', [],...
            'use_only_gradeable', 1,...
            'min_num_markers', i_ob,...
            'max_missing_markers', inf, ...
            'plot', 0);

        plot(a1, out_stats.fp_counts/out_stats.total_images, out_stats.roc_pts_adjusted(:,2), '-', 'linewidth', 2);
    end
    leg_text = cellstr(strcat('\lambda = ', num2str(sort(class_thresh, 'descend')')));
    legend(leg_text, 'location', 'southeast');
    title({'Sensitivity vs FPs per image - apex offset votes from individual trees, minimum threshold \lambda';...
        ['Minimum observers for a target apex: ' num2str(i_ob)]});
    xlabel('FPs per image');
    ylabel('Sensitivity - % of target apexes detected');
    
    saveas(gcf, ['C:\isbe\matlab_code\trunk\papers\2014miccai\figs\pooled_tree_apex_offsets(' num2str(i_ob) ').fig']);
end
%%
candidates_dir = [apex_map_dir 'incremental_maxima\separate_trees\'];
create_folder(candidates_dir);
for i_im = 1:length(im_list);
    im_name = im_list(i_im).name(1:6);
    display(['Processing image ' num2str(i_im) ', ' datestr(now)]);
    
    load([apex_map_dir im_name '_pred.mat']);
    load([vessel_centres_dir im_name '_vc.mat']);
    f_mask = u_load([fov_mask_dir im_name '_f_mask.mat']);
    
    [discard_pts] = discard_edge_preds(vessel_centre, f_mask);
    include_pts = ~discard_pts;
    
    incremental_apex_offset_preds(apex_class_pred, apex_offset_x_pred, apex_offset_y_pred,...
        vessel_centre, nrows, ncols, include_pts, class_thresh, candidates_dir, im_name, ... % non-strict mode
        'separate_trees',       1,...
        'base_width',           20,...
        'exclsuion_zone',       20,...
        'fov_mask',             f_mask,...
        'plot',                 0);

end
%
for i_th = 1:20
    candidates_dir_i = [candidates_dir '\thresh' zerostr(i_th,2) '\'];
    
    make_detection_results_struc(...
        'results_name', 'detection_results', ...
        'candidates_dir',    candidates_dir_i,... %mandatory arguments
        'apex_gt_dir', [nailfoldroot 'data/rsa_study/test_half/apex_gt/'],...
        'results_dir', [candidates_dir_i 'results\'],...
        'prob_dir', [nailfoldroot 'data/rsa_study/test_half/predictions/detection/rf_classification/296655/'],...
        'selected_gt', [],...
        'selected_candidates', [],...
        'selected_prob', []);
end
%%
candidates_dir = [apex_map_dir 'incremental_maxima\separate_trees\'];
for i_ob = 2%1:2
    figure; hold all; a1 = gca;
    for i_th = 1:20
        candidates_dir_i = [candidates_dir '\thresh' zerostr(i_th,2) '\'];

        [out_stats] = analyse_incremental_rocs(...
            'results_name', 'detection_results',...
            'candidates_dir',    candidates_dir_i,... %mandatory arguments
            'apex_gt_dir', [nailfoldroot 'data/rsa_study/test_half/apex_gt/'],...
            'results_dir', [candidates_dir_i 'results\'],...
            'selected_images', [],...
            'use_only_gradeable', 1,...
            'min_num_markers', i_ob,...
            'max_missing_markers', inf, ...
            'plot', 0);

        plot(a1, out_stats.fp_counts/out_stats.total_images, out_stats.roc_pts_adjusted(:,2), '-', 'linewidth', 2);
    end
    leg_text = cellstr(strcat('\lambda = ', num2str(sort(class_thresh, 'descend')')));
    legend(leg_text, 'location', 'southeast');
    title({'Sensitivity vs FPs per image - apex offset votes from individual trees, minimum threshold \lambda';...
        ['Minimum observers for a target apex: ' num2str(i_ob)]});
    xlabel('FPs per image');
    ylabel('Sensitivity - % of target apexes detected');
    
    saveas(gcf, ['C:\isbe\matlab_code\trunk\papers\2014miccai\figs\invidual_tree_apex_offsets(' num2str(i_ob) ').fig']);
end
