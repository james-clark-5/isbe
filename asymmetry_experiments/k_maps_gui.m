function [] = k_maps_gui(varargin)
%OBSERVER_STUDY_GUI *Insert a one line summary here*
%   [] = observer_study_gui()
%
% Inputs:
%
% Outputs:
%
% Example:
%
% Notes:
%
% See also:
%
% Created: 14-May-2009
% Author: Michael Berks 
% Email : michael.berks@postgrad.man.ac.uk 
% Phone : +44 (0)161 275 1241 
% Copyright: (C) University of Manchester

%--------------------------------------------------------------------------
%--------------------------------------------------------------------------
% Program code that runs
%
%--------------------------------------------------------------------------
%Must have window style set to normal
orig_window_style = get(0,'DefaultFigureWindowStyle');
if ~strcmp(orig_window_style, 'normal')
    display('Warning: changing window style to normal for function');
    set(0,'DefaultFigureWindowStyle','normal');
end

%Set constants/variables that persist for all user sessions:
color1 = [1 1 1];
color2 = [212 208 200]/255; %#ok
color3 = [0 0 0];
buff = 5;
screen_size = get(0,'ScreenSize');

%Create empty variables that exist globally and will be filled auxilliary
%functions - this set do not need to be reset for each session
if strcmpi(getenv('UserName'), 'mberks')
    mammo_dir = 'C:\isbe\asymmetry_project\data\mammograms\2004_screening\abnormals\';
    map_dir = 'C:\isbe\asymmetry_project\data\k_stellate_maps\rf\2004_screening_processed\abnormals\';
else
    mammo_dir = 'E:\asymmetry_project\data\mammograms\2004_screening\abnormals\';
    map_dir = 'E:\asymmetry_project\data\k_stellate_maps\rf\2004_screening_processed\abnormals\';
end

num_pairs = [];
pair_strings = [];
pair_num = [];
pair_view = [];
curr_pair = [];
curr_smoothing = 1;
curr_map = inf;

mam_r = [];
mam_l = [];
mask_r = [];
mask_l = [];
f1_r = [];
f1_l = [];
f1_scaling_r = [];
f1_scaling_l = [];
f2_r = [];
f2_l = [];
f2_scaling_r = [];
f2_scaling_l = [];
f1_or_f2 = 1;
do_max = 0;

ui = [];
axes_pos1 = [];
axes_pos2 = [];
axes_pos3 = [];
axes_pos4 = [];
axes_pos5 = [];
axes_pos6 = [];
panel_pos = [];

meta_lx = [];
meta_rx = [];
meta_ly = [];
meta_ry = [];

args = u_packargs(varargin,... % the user's input
    '0', ... % non-strict mode
    'spacing', 2,...
    'offset_x', 0,...
    'offset_y', 0,...
    'r_max', {'107', '133', '180', '207', '260'});
clear varargin;

spacing = args.spacing;
offset_x = args.offset_x;
offset_y = args.offset_y;
r_max = args.r_max;

%main program
create_main_fig
%get_pair_information;

%Reset window style
set(0,'DefaultFigureWindowStyle',orig_window_style);

%End of function

%--------------------------------------------------------------------------
%--------------------------------------------------------------------------
% Auxilliary functions so set up main UI figure (axes, buttons etc)
%
%--------------------------------------------------------------------------
    function create_main_fig
        %Generate main figure if it doens't already exist

        ui.main_fig = figure(...
            'Position', [0 30 screen_size(3), screen_size(4)-50],...
            'Visible','on',...
            'Name', 'Organisation maps display tool',...
            'NumberTitle', 'off',...
            'MenuBar', 'none',...
            'WindowStyle', 'normal',...
            'Color', color1,...
            'CloseRequestFcn', @quit_Callback);
        
        
        x_max = screen_size(3);
        y_max = screen_size(4)-50;
        button_h = 40;
        button_w = 100;
        text_w = 250;
        panel_h = 65;
 
        
        figure(ui.main_fig);
        set(ui.main_fig,...
            'Color', color3,...
            'CloseRequestFcn', @quit_Callback);
        
        panel_w = 400;
        axes_cx = (x_max - panel_w)/2;
        axes_h = (y_max - 3*buff) / 2;
        axes_w = 0.8*axes_h;
        
        axes_pos1 = [axes_cx-0.5*buff-axes_w  2*buff+axes_h axes_w axes_h];
        axes_pos2 = [axes_cx+0.5*buff         2*buff+axes_h axes_w axes_h];
        axes_pos3 = [axes_cx-0.5*buff-axes_w  buff          axes_w axes_h];
        axes_pos4 = [axes_cx+0.5*buff         buff          axes_w axes_h];
        axes_pos5 = [axes_pos4(1)-5 axes_pos3(2) 20 axes_pos4(4)];
        axes_pos6 = [axes_pos2(1)-5 axes_pos1(2) 20 axes_pos2(4)];
        panel_pos = [x_max - panel_w - buff, buff, panel_w, y_max - 2*buff];
        
        ui.panel_main = uicontrol(...
            'Style','frame',...
            'Parent', ui.main_fig,...
            'Units', 'pixels',...
            'Position', panel_pos,...
            'Visible', 'on');
        
        %------------------------------------------------------------------
        pp = 1;
        ui.panel{pp} = uipanel(...
            'Parent', ui.main_fig,...
            'Units', 'pixels',...
            'Position', [panel_pos(1)+buff y_max-buff-panel_h panel_w-2*buff panel_h],...
            'Visible', 'on');
           
        ui.mammo_dir_text = uicontrol(... 
            'Parent', ui.panel{pp},... 
            'Style','text',...
            'BackgroundColor', get(ui.panel_main, 'BackgroundColor'),...
            'FontName', 'Arial',...
            'String', 'Mammogram pairs folder:',...
            'HorizontalAlignment', 'left',...
            'Position', [0 button_h text_w 25]); 

        ui.mammo_dir_box = uicontrol(...
            'Style', 'edit',...
            'Position', [buff buff text_w button_h],...
            'BackgroundColor', [1 1 1],...
            'Parent', ui.panel{pp},...
            'String', mammo_dir);

        ui.mammo_dir_select = uicontrol(... 
            'Style', 'pushbutton',...
            'Position', [2*buff+text_w buff button_w button_h],...
            'String', 'Select',...
            'Parent', ui.panel{pp},...
            'Callback', @mammo_dir_select_Callback);
        pp = pp + 1;
        %---------------------------------------------------------------
        ui.panel{pp} = uipanel(...
            'Parent', ui.main_fig,...
            'Units', 'pixels',...
            'Position', [panel_pos(1)+buff y_max-2*(buff+panel_h) panel_w-2*buff panel_h],...
            'Visible', 'on');
           
        ui.map_dir_text = uicontrol(... 
            'Parent', ui.panel{pp},... 
            'Style','text',...
            'BackgroundColor', get(ui.panel_main, 'BackgroundColor'),...
            'FontName', 'Arial',...
            'String', 'Organisation maps folder:',...
            'HorizontalAlignment', 'left',...
            'Position', [0 button_h text_w 25]); 

        ui.map_dir_box = uicontrol(...
            'Style', 'edit',...
            'Position', [buff buff text_w button_h],...
            'BackgroundColor', [1 1 1],...
            'Parent', ui.panel{pp},...
            'String', map_dir);

        ui.map_dir_select = uicontrol(... 
            'Style', 'pushbutton',...
            'Position', [2*buff+text_w buff button_w button_h],...
            'String', 'Select',...
            'Parent', ui.panel{pp},...
            'Callback', @map_dir_select_Callback);
        pp = pp + 1;
        %---------------------------------------------------------------
        ui.panel{pp} = uipanel(...
            'Parent', ui.main_fig,...
            'Units', 'pixels',...
            'Position', [panel_pos(1)+buff y_max-3*(buff+panel_h) panel_w-2*buff panel_h],...
            'Visible', 'on');
           
        ui.update = uicontrol(... 
            'Parent', ui.panel{pp},... 
            'Style','pushbutton',...
            'String','Update data source',...
            'Tag','update',...
            'Callback', @update_Callback,...
            'Position', [buff, panel_h-buff-button_h, text_w, button_h]);
        pp = pp + 1;
        %---------------------------------------------------------------
        ui.panel{pp} = uipanel(...
            'Parent', ui.main_fig,...
            'Units', 'pixels',...
            'Position', [panel_pos(1)+buff y_max-4*(buff+panel_h) panel_w-2*buff panel_h],...
            'Visible', 'on');
        
        ui.pair_number_text = uicontrol(... 
            'Parent', ui.panel{pp},... 
            'Style','text',...
            'BackgroundColor', get(ui.panel_main, 'BackgroundColor'),...
            'FontName', 'Arial',...
            'String', 'Select mammogram pair:',...
            'HorizontalAlignment', 'left',...
            'Position', [0 button_h+buff text_w 25]); 
        
        ui.pair_number_selecter = uicontrol(...
            'Parent', ui.panel{pp},...
            'Style', 'popupmenu',...
            'Position', [2*buff+button_w buff text_w-buff-button_w button_h],...
            'String', ' ',...
            'Enable', 'off',...
            'Callback', @pair_number_selecter_Callback);
        
        ui.previous_pair = uicontrol(...
            'Parent', ui.panel{pp},...
            'Style','pushbutton',...
            'String','Previous',...
            'Callback', @previous_pair_Callback,...
            'Position', [buff, buff, button_w, button_h],....
            'Enable', 'off');
        ui.next_pair = uicontrol(...
            'Parent', ui.panel{pp},...
            'Style','pushbutton',...
            'String','Next',...
            'Callback', @next_pair_Callback,...
            'Position', [2*buff+text_w, buff, button_w, button_h],...
            'BackgroundColor', color2,...
            'Enable', 'off');
        pp = pp + 1;
        %---------------------------------------------------------------
        ui.panel{pp} = uipanel(...
            'Parent', ui.main_fig,...
            'Units', 'pixels',...
            'Position', [panel_pos(1)+buff y_max-5*(buff+panel_h) panel_w-2*buff panel_h],...
            'Visible', 'on');
        
        ui.r_max_slider_text = uicontrol(... 
            'Parent', ui.panel{pp},... 
            'Style','text',...
            'BackgroundColor', get(ui.panel_main, 'BackgroundColor'),...
            'FontName', 'Arial',...
            'String', 'Select r_max:',...
            'HorizontalAlignment', 'left',...
            'Position', [0 25 text_w 25]); 
        
        ui.r_max_slider = uicontrol(... 
            'Style', 'slider',...
            'Position', [buff buff text_w+button_w+buff 25],...
            'String', 'Select',...
            'Min', 0,...
            'Max', 1,...
            'Value', 0,...
            'SliderStep', [1/3 1/3],...
            'Parent', ui.panel{pp},...
            'Enable', 'off',...
            'Callback', @r_max_slider_Callback);
        pp = pp + 1;
        %---------------------------------------------------------------
        ui.panel{pp} = uipanel(...
            'Parent', ui.main_fig,...
            'Units', 'pixels',...
            'Position', [panel_pos(1)+buff y_max-6*(buff+panel_h) panel_w-2*buff panel_h],...
            'Visible', 'on');
        
        ui.smoothing_slider_text = uicontrol(... 
            'Parent', ui.panel{pp},... 
            'Style','text',...
            'BackgroundColor', get(ui.panel_main, 'BackgroundColor'),...
            'FontName', 'Arial',...
            'String', 'Select map smoothing: sigma = 1' ,...
            'HorizontalAlignment', 'left',...
            'Position', [0 25 text_w 25]); 
        
        ui.smoothing_slider = uicontrol(... 
            'Style', 'slider',...
            'Position', [buff buff text_w+button_w+buff 25],...
            'String', 'Select',...
            'Min', 1,...
            'Max', 6,...
            'Value', 1,...
            'SliderStep', [0.2 0.2],...
            'Parent', ui.panel{pp},...
            'Enable', 'off',...
            'Callback', @smoothing_slider_Callback);
        pp = pp + 1;
        %---------------------------------------------------------------
        ui.panel{pp} = uipanel(...
            'Parent', ui.main_fig,...
            'Units', 'pixels',...
            'Position', [panel_pos(1)+buff y_max-7*(buff+panel_h) panel_w-2*buff panel_h],...
            'Visible', 'on');
        
        ui.min_c_slider_text = uicontrol(... 
            'Parent', ui.panel{pp},... 
            'Style','text',...
            'BackgroundColor', get(ui.panel_main, 'BackgroundColor'),...
            'FontName', 'Arial',...
            'String', 'Select min/max values of map contrast range: ' ,...
            'HorizontalAlignment', 'left',...
            'Position', [0 25 text_w+button_w+buff 25]); 
        
        ui.min_c_slider = uicontrol(... 
            'Style', 'slider',...
            'Position', [buff buff (text_w+button_w)/2 25],...
            'String', 'Select',...
            'Min', 0,...
            'Max', 1,...
            'Value', 0,...
            'SliderStep', [0.01 0.1],...
            'Parent', ui.panel{pp},...
            'Enable', 'off',...
            'Callback', @min_c_slider_Callback);
        
        ui.max_c_slider = uicontrol(... 
            'Style', 'slider',...
            'Position', [2*buff+(text_w+button_w)/2 buff (text_w+button_w)/2 25],...
            'String', 'Select',...
            'Min', 0,...
            'Max', 1,...
            'Value', 0,...
            'SliderStep', [0.01 0.1],...
            'Parent', ui.panel{pp},...
            'Enable', 'off',...
            'Callback', @max_c_slider_Callback);
        pp = pp + 1;
        %---------------------------------------------------------------
        ui.panel{pp} = uipanel(...
            'Parent', ui.main_fig,...
            'Units', 'pixels',...
            'Position', [panel_pos(1)+buff y_max-8*(buff+panel_h) panel_w-2*buff panel_h],...
            'Visible', 'on');
        
        ui.min_m_slider_text = uicontrol(... 
            'Parent', ui.panel{pp},... 
            'Style','text',...
            'BackgroundColor', get(ui.panel_main, 'BackgroundColor'),...
            'FontName', 'Arial',...
            'String', 'Select min/max values of mammogram contrast range: ' ,...
            'HorizontalAlignment', 'left',...
            'Position', [0 25 text_w+button_w+buff 25]); 
        
        ui.min_m_slider = uicontrol(... 
            'Style', 'slider',...
            'Position', [buff buff (text_w+button_w)/2 25],...
            'String', 'Select',...
            'Min', 0,...
            'Max', 1,...
            'Value', 0,...
            'SliderStep', [0.01 0.1],...
            'Parent', ui.panel{pp},...
            'Enable', 'off',...
            'Callback', @min_m_slider_Callback);
        
        ui.max_m_slider = uicontrol(... 
            'Style', 'slider',...
            'Position', [2*buff+(text_w+button_w)/2 buff (text_w+button_w)/2 25],...
            'String', 'Select',...
            'Min', 0,...
            'Max', 1,...
            'Value', 0,...
            'SliderStep', [0.01 0.1],...
            'Parent', ui.panel{pp},...
            'Enable', 'off',...
            'Callback', @max_m_slider_Callback);
        pp = pp + 1;
        
        %---------------------------------------------------------------
        ui.panel{pp} = uipanel(...
            'Parent', ui.main_fig,...
            'Units', 'pixels',...
            'Position', [panel_pos(1)+buff y_max-pp*(buff+panel_h) panel_w-2*buff panel_h],...
            'Visible', 'on');
        
        ui.zoom_on = uicontrol(... 
            'Parent', ui.panel{pp},... 
            'Style','togglebutton',...
            'String','Zoom',...
            'Tag','zoom_on',...
            'Callback', @zoom_Callback,...
            'Position', [buff, buff, 0.75*button_w, button_h],...
            'Enable', 'off'); 
        
        ui.pan_on = uicontrol(... 
            'Parent', ui.panel{pp},... 
            'Style','togglebutton',...
            'String','Pan',...
            'Tag','zoom_on',...
            'Callback', @pan_Callback,...
            'Position', [2*buff+0.75*button_w, buff, 0.75*button_w, button_h],...
            'Enable', 'off');
        
        ui.meta_on = uicontrol(... 
            'Parent', ui.panel{pp},... 
            'Style','togglebutton',...
            'String','Markers',...
            'Tag','zoom_on',...
            'Callback', @meta_Callback,...
            'Position', [3*buff+2*0.75*button_w, buff, 0.75*button_w, button_h],...
            'Enable', 'off');
        
        ui.f1_or_f2 = uicontrol(... 
            'Parent', ui.panel{pp},... 
            'Style','pushbutton',...
            'String','Show F2',...
            'Tag','f1_or_f2',...
            'Callback', @f1_or_f2_Callback,...
            'Position', [4*buff+3*0.75*button_w, buff, 0.75*button_w, button_h],...
            'Enable', 'off'); 
        pp = pp + 1;
        
        %---------------------------------------------------------------
        ui.panel{pp} = uipanel(...
            'Parent', ui.main_fig,...
            'Units', 'pixels',...
            'Position', [panel_pos(1)+buff y_max-pp*(buff+panel_h) panel_w-2*buff panel_h],...
            'Visible', 'on');
        
        ui.do_max = uicontrol(... 
            'Parent', ui.panel{pp},... 
            'Style','togglebutton',...
            'String','Max over scale',...
            'Tag','do_max',...
            'Callback', @do_max_Callback,...
            'Position', [buff, buff, 0.75*button_w, button_h],...
            'Enable', 'off'); 

        %---------------------------------------------------------------                    
        ui.axes1 = axes(...
            'Parent', ui.main_fig,...
            'Units', 'pixels',...
            'Visible', 'off');
        ui.region1 = imagesc([]);
        set(ui.axes1,...
            'Position', axes_pos1,...
            'Xtick', [],...
            'Ytick', [],...
            'YDir','reverse',...
            'NextPlot', 'add');
        
        ui.axes2 = axes(...
            'Parent', ui.main_fig,...
            'Units', 'pixels',...
            'Visible', 'off');
        ui.region2 = imagesc([]);
        set(ui.axes2,...
            'Position', axes_pos2,...
            'Xtick', [],...
            'Ytick', [],...
            'YDir','reverse',...
            'NextPlot', 'add');
        
        ui.axes3 = axes(...
            'Parent', ui.main_fig,...
            'Units', 'pixels',...
            'Visible', 'off');
        ui.region3 = imagesc([]);
        set(ui.axes3,...
            'Position', axes_pos3,...
            'Xtick', [],...
            'Ytick', [],...
            'YDir','reverse',...
            'NextPlot', 'add');
        
        ui.axes4 = axes(...
            'Parent', ui.main_fig,...
            'Units', 'pixels',...
            'Visible', 'off');
        ui.region4 = imagesc([]);
        set(ui.axes4,...
            'Position', axes_pos4,...
            'Xtick', [],...
            'Ytick', [],...
            'YDir','reverse',...
            'NextPlot', 'add');
        
        linkaxes([ui.axes1 ui.axes3]);
        linkaxes([ui.axes2 ui.axes4]);
        
        ui.axes5 = axes(...
            'Parent', ui.main_fig,...
            'Units', 'pixels');
        ui.region5 = imagesc([]);
        set(ui.axes5,...
            'Xtick', [],...
            'Position', axes_pos5); 
        
        ui.axes6 = axes(...
            'Parent', ui.main_fig,...
            'Units', 'pixels');
        ui.region6 = imagesc([]);
        set(ui.axes6,...
            'Xtick', [],...
            'Position', axes_pos6); 
        
        
        set(ui.main_fig,...
             'Colormap', [jet(128); gray(128)]);
        
        ui.meta1 = plot(1, 1,...
            'Parent', ui.axes1,...
            'Visible', 'off',...
            'Marker', '.',...
            'MarkerEdgeColor', 'r',...
            'MarkerSize', 2,...
            'LineStyle', 'none');
        ui.meta2 = plot(1, 1,...
            'Parent', ui.axes2,...
            'Visible', 'off',...
            'Marker', '.',...
            'MarkerEdgeColor', 'r',...
            'MarkerSize', 2,...
            'LineStyle', 'none');
        ui.meta3 = plot(1, 1,...
            'Parent', ui.axes3,...
            'Visible', 'off',...
            'Marker', '.',...
            'MarkerEdgeColor', 'k',...
            'MarkerSize', 2,...
            'LineStyle', 'none');
        ui.meta4 = plot(1, 1,...
            'Parent', ui.axes4,...
            'Visible', 'off',...
            'Marker', '.',...
            'MarkerEdgeColor', 'k',...
            'MarkerSize', 2,...
            'LineStyle', 'none');
        
        ui.popup_fig = figure(...
            'WindowStyle', 'Normal',...
            'Position', [50 50 450 600],...
            'Visible', 'off');
        ui.popup_axes(1) = subplot(2,1,1);
        ui.popup_axes(2) = subplot(2,1,2);
        ui.popup_idx = 1;
        
    end

%--------------------------------------------------------------------------
%--------------------------------------------------------------------------
% Auxilliary functions that control data
%
%--------------------------------------------------------------------------

    function get_pair_information
        pair_list = dir([map_dir '\*.mat']);
        [pair_nums breasts pair_views] = get_mammo_info(pair_list);
        pair_strings = unique(strcat(pair_nums, {' '}, pair_views));
        num_pairs = length(pair_strings);
        
        if num_pairs
            curr_pair = 1;
            
            %Update uicontrols now we have data
            set(ui.pair_number_selecter,...
                'Enable', 'on',...
                'String', pair_strings);

            %Load in the images for the first pair and upfate the pair
            %selecter
            update_curr_pair;
            
            set(ui.zoom_on, 'Enable', 'on');
            set(ui.pan_on, 'Enable', 'on');
            set(ui.meta_on, 'Enable', 'on');
            set(ui.f1_or_f2, 'Enable', 'on');
            set(ui.do_max, 'Enable', 'on');
            set(ui.smoothing_slider, 'Enable', 'on');
        else
            warndlg('No confocality maps found in this directory');
        end        
    end
%--------------------------------------------------------------------------       
    function load_mammograms
        h = waitbar(0,'Loading mammograms. Please wait...');
        
        %Work out the names of the associated mammograms
        mammo_name_l = dir([mammo_dir '\*' pair_num 'L' pair_view '*']);
        mammo_name_r = dir([mammo_dir '\*' pair_num 'R' pair_view '*']);
        mammo_name_l = [mammo_dir '\' mammo_name_l(1).name];
        mammo_name_r = [mammo_dir '\' mammo_name_r(1).name];
       
        %Load in the mammograms
        if strcmpi(mammo_name_r(end-3:end), '.mat')
            mam_r = u_load(mammo_name_r);
        else
            mam_r = imread(mammo_name_r);
        end
        if strcmpi(mammo_name_l(end-3:end), '.mat')
            mam_l = u_load(mammo_name_l);
        else
            mam_l = imread(mammo_name_l);
        end       
        
        %Now check for meta data (i.e. abnormality annotations)
        meta_lx = [];
        meta_rx = [];
        meta_ly = [];
        meta_ry = [];
        if exist([mammo_dir '\meta'], 'dir')
            meta_name_l = dir([mammo_dir '\meta\*' pair_num 'L' pair_view '*']);
            if ~isempty(meta_name_l)
                meta_l = u_load([mammo_dir '\meta\' meta_name_l(1).name]);
                if ~isempty(meta_l)
                    meta_lx = meta_l(:,1);
                    meta_ly = meta_l(:,2);
                end
            end
            meta_name_r = dir([mammo_dir '\meta\*' pair_num 'R' pair_view '*']);
            if ~isempty(meta_name_r)
                meta_r = u_load([mammo_dir '\meta\' meta_name_r(1).name]);
                if ~isempty(meta_r)
                    meta_rx = meta_r(:,1);
                    meta_ry = meta_r(:,2);
                end
            end    
        end
        close(h);
        
        update_mammo_axes_display;
    end
%--------------------------------------------------------------------------
    function load_maps
        
        h = waitbar(0,'Loading maps. Please wait...');
        
        %Load masks
        mask_r = u_load([map_dir '\' pair_num 'R' pair_view '_mask.mat']);
        mask_l = u_load([map_dir '\' pair_num 'L' pair_view '_mask.mat']);
        
        %Reduce mask so to keep only pixels where we've computed features
        mask_r = mask_r(offset_y+(1:spacing:end), offset_x+(1:spacing:end));
        mask_l = mask_l(offset_y+(1:spacing:end), offset_x+(1:spacing:end));
        
        %Load f1 maps and scaling factors
        s = load([map_dir '\' pair_num 'R' pair_view '_f1.mat']);
        if isfield(s, 'zero_mask');
            f1_r = uint8(s.zero_mask);
            f1_r(s.zero_mask) = s.out_var;
        else
            f1_r = s.out_var;
        end
        f1_scaling_r = s.scaling; clear s;
        s = load([map_dir '\' pair_num 'L' pair_view '_f1.mat']);
        if isfield(s, 'zero_mask');
            f1_l = uint8(s.zero_mask);
            f1_l(s.zero_mask) = s.out_var;
        else
            f1_l = s.out_var;
        end
        f1_scaling_l = s.scaling; clear s;
        
        %Load f2 maps and scaling factors
        s = load([map_dir '\' pair_num 'R' pair_view '_f2.mat']);         
        if isfield(s, 'zero_mask');
            f2_r = uint8(s.zero_mask);
            f2_r(s.zero_mask) = s.out_var;
        else
            f2_r = s.out_var;
        end
        f2_scaling_r = s.scaling; clear s;
        s = load([map_dir '\' pair_num 'L' pair_view '_f2.mat']);
        if isfield(s, 'zero_mask');
            f2_l = uint8(s.zero_mask);
            f2_l(s.zero_mask) = s.out_var;
        else
            f2_l = s.out_var;
        end
        f2_scaling_l = s.scaling; clear s;
        
        num_maps = max(size(f1_r,2), size(f1_l,2));
        
        if curr_map > num_maps;
            curr_map = num_maps;
        end
        
        if num_maps > 1
            set(ui.r_max_slider,...
                'Min', 1,...
                'Max', num_maps,...
                'SliderStep', [1/(num_maps-1) 1/(num_maps-1)],...
                'Value', curr_map,...
                'Enable', 'on');
        end
        
        update_map_axes_display;
        
        close(h);
    end
%--------------------------------------------------------------------------
    function update_map_axes_display
        
        %Create feature maps using mask and features
        f_map_r = zeros(size(mask_r));
        f_map_l = zeros(size(mask_l));
        
        if do_max
            if f1_or_f2 == 1
                %f_map_r(mask_r) = (f1_scaling_r.m * double(max(f1_r,[],2)) / 255) + f1_scaling_r.c;
                %f_map_l(mask_l) = (f1_scaling_l.m * double(max(f1_l,[],2)) / 255) + f1_scaling_l.c;
                f_map_r(mask_r) = (f1_scaling_r.m * double(sum(f1_r,2)) / 255) + f1_scaling_r.c;
                f_map_l(mask_l) = (f1_scaling_l.m * double(sum(f1_l,2)) / 255) + f1_scaling_l.c;
            else
                %f_map_r(mask_r) = (f2_scaling_r.m * double(max(f2_r,[],2)) / 255) + f2_scaling_r.c;
                %f_map_l(mask_l) = (f2_scaling_l.m * double(max(f2_l,[],2)) / 255) + f2_scaling_l.c;
                f_map_r(mask_r) = (f2_scaling_r.m * double(sum(f2_r,2)) / 255) + f2_scaling_r.c;
                f_map_l(mask_l) = (f2_scaling_l.m * double(sum(f2_l,2)) / 255) + f2_scaling_l.c;
            end
        else
            if f1_or_f2 == 1
                f_map_r(mask_r) = (f1_scaling_r.m * double(f1_r(:,curr_map)) / 255) + f1_scaling_r.c;
                f_map_l(mask_l) = (f1_scaling_l.m * double(f1_l(:,curr_map)) / 255) + f1_scaling_l.c;
            else
                f_map_r(mask_r) = (f2_scaling_r.m * double(f2_r(:,curr_map)) / 255) + f2_scaling_r.c;
                f_map_l(mask_l) = (f2_scaling_l.m * double(f2_l(:,curr_map)) / 255) + f2_scaling_l.c;
            end
        end
        
        %Smooth the maps
        f_map_r = imfilter(f_map_r, fspecial('gaussian', round(5*curr_smoothing), curr_smoothing));
        f_map_l = imfilter(f_map_l, fspecial('gaussian', round(5*curr_smoothing), curr_smoothing));
        
        %Compute map limits for color scaling
        max_map = max([max(f_map_r(:)) max(f_map_l(:))]);
        min_map = min([min(f_map_r(:)) min(f_map_l(:))]);
        map_lim = [min_map 2*max_map-min_map];
        
        set(ui.axes3, 'Clim', map_lim);
        set(ui.axes4, 'Clim', map_lim);
        set(ui.axes5,...
            'Clim', map_lim,...
            'XColor', 'red',...
            'YColor', 'red',...
            'Xtick', [],...
            'YTickLabel', num2str(linspace(min_map, max_map, length(get(ui.axes5, 'Ytick')))',3));
        
        %Make the maps visible
        set(ui.region3,...
            'Visible', 'on',...
            'CData', f_map_r,...
            'XData', [1 axes_pos3(3)],...
            'YData', [1 axes_pos3(4)],...
            'ButtonDownFcn', @display_hist);
        set(ui.region4,...
            'Visible', 'on',...
            'CData', f_map_l,...
            'XData', [1 axes_pos4(3)],...
            'YData', [1 axes_pos4(4)],...
            'ButtonDownFcn', @display_hist);
        set(ui.region5,...
            'Visible', 'on',...
            'CData', linspace(0, max_map, 128)',...
            'XData', [1 axes_pos5(3)],...
            'YData', [1 axes_pos5(4)]);
        
        set(ui.meta3,...
            'XData', axes_pos3(3)*meta_rx,...
            'YData', axes_pos3(4)*meta_ry);
        set(ui.meta4,...
            'XData', axes_pos4(3)*meta_lx,...
            'YData', axes_pos4(4)*meta_ly);
        
        set(ui.min_c_slider,...
            'Min', min_map,...
            'Max', 0.99*max_map,...
            'Value', min_map,...
            'Enable', 'on')
        set(ui.max_c_slider,...
            'Min', 1.01*min_map,...
            'Max', max_map,...
            'Value', max_map,...
            'Enable', 'on')
        
        set(ui.min_c_slider_text,...
            'String', ['Select min/max values of map contrast range: [' num2str(min_map,3) ', ' num2str(max_map,3) ']']);
        set(ui.r_max_slider_text, 'String', ['Select r_max: r_max = ' r_max{curr_map}]);
        
    end

    function update_mammo_axes_display
        
        %Compute the apsect ratios for these images (they may vary from
        %pair to pair)
        aspect_ratio_r = size(mam_r,2) / size(mam_r,1);
        aspect_ratio_l = size(mam_l,2) / size(mam_l,1);
        
        %Update the size and position of the axes
        axes_pos1(1) = axes_pos1(1) + axes_pos1(3) - axes_pos1(4)*aspect_ratio_r;
        axes_pos3(1) = axes_pos3(1) + axes_pos3(3) - axes_pos3(4)*aspect_ratio_r;
        
        axes_pos1(3) = axes_pos1(4)*aspect_ratio_r;
        axes_pos2(3) = axes_pos2(4)*aspect_ratio_l;
        axes_pos3(3) = axes_pos3(4)*aspect_ratio_r;
        axes_pos4(3) = axes_pos4(4)*aspect_ratio_l;
        
        axes_pos5(1) = axes_pos4(1) - 5;
        axes_pos6(1) = axes_pos2(1) - 5;
        
        
        set(ui.axes1,...
            'Position', axes_pos1,...
            'Xlim', [0.5 axes_pos1(3)+0.5],...
            'Ylim', [0.5 axes_pos1(4)+0.5]);
        set(ui.axes2,...
            'Position', axes_pos2,...
            'Xlim', [0.5 axes_pos2(3)+0.5],...
            'Ylim', [0.5 axes_pos2(4)+0.5]);
        set(ui.axes3,...
            'Position', axes_pos3,...
            'Xlim', [0.5 axes_pos3(3)+0.5],...
            'Ylim', [0.5 axes_pos3(4)+0.5]);
        set(ui.axes4,...
            'Position', axes_pos4,...
            'Xlim', [0.5 axes_pos4(3)+0.5],...
            'Ylim', [0.5 axes_pos4(4)+0.5]);
        set(ui.axes5,...
            'Position', axes_pos5,...
            'Xlim', [0.5 axes_pos5(3)+0.5],...
            'Ylim', [0.5 axes_pos5(4)+0.5]);
        set(ui.axes6,...
            'Position', axes_pos6,...
            'Xlim', [0.5 axes_pos6(3)+0.5],...
            'Ylim', [0.5 axes_pos6(4)+0.5]);
       
        %Compute mammo limits for color scaling
        max_mammo = double(max([max(mam_r(:)) max(mam_l(:))]));
        min_mammo = double(min([min(mam_r(:)) min(mam_l(:))]));
        mammo_lim = [2*min_mammo - max_mammo max_mammo];
        
        set(ui.axes1, 'Clim', mammo_lim);
        set(ui.axes2, 'Clim', mammo_lim);
        set(ui.axes6,...
            'Clim', mammo_lim,...
            'XColor', 'red',...
            'YColor', 'red',...
            'Xtick', [],...
            'YTickLabel', num2str(linspace(min_mammo, max_mammo, length(get(ui.axes6, 'Ytick')))',3));
        
        %Make the mammograms visible
        set(ui.region1,...
            'Visible', 'on',...
            'CData', mam_r,...
            'XData', [1 axes_pos1(3)],...
            'YData', [1 axes_pos1(4)]);
        set(ui.region2,...
            'Visible', 'on',...
            'CData', mam_l,...
            'XData', [1 axes_pos2(3)],...
            'YData', [1 axes_pos2(4)]);
        set(ui.region6,...
            'Visible', 'on',...
            'CData', linspace(min_mammo, max_mammo, 128)',...
            'XData', [1 axes_pos6(3)],...
            'YData', [1 axes_pos6(4)]);
        
        set(ui.meta1,...
            'XData', axes_pos1(3)*meta_rx,...
            'YData', axes_pos1(4)*meta_ry);
        set(ui.meta2,...
            'XData', axes_pos2(3)*meta_lx,...
            'YData', axes_pos2(4)*meta_ly);
        
        set(ui.min_m_slider,...
            'Min', 0,...
            'Max', 0.99*max_mammo,...
            'Value', 0,...
            'Enable', 'on')
        set(ui.max_m_slider,...
            'Min', 0.01,...
            'Max', max_mammo,...
            'Value', max_mammo,...
            'Enable', 'on')
        
        set(ui.min_m_slider_text,...
            'String', ['Select min/max values of mammo contrast range: [' num2str(min_mammo,3) ', ' num2str(max_mammo,3) ']']);
        
        
    end
%----------------------------------------------------------------------
    function update_curr_pair
        
        set(ui.pair_number_text, 'String', ['Select mammogram pair:' num2str(curr_pair) ' of ' num2str(num_pairs)]);
        set(ui.pair_number_selecter, 'Value', curr_pair);
        
        if curr_pair == num_pairs
            set(ui.next_pair, 'Enable', 'off');
        else
            set(ui.next_pair, 'Enable', 'on');
        end
        if curr_pair == 1
            set(ui.previous_pair, 'Enable', 'off');
        else
            set(ui.previous_pair, 'Enable', 'on');
        end

        %Work out the case number and view type for this pair of maps
        pair_num = pair_strings{curr_pair}(1:3);
        pair_view = pair_strings{curr_pair}(5:6);

        %Load in the maps and mammograms and update the display
        load_mammograms;
        load_maps;
    end
%--------------------------------------------------------------------------
%--------------------------------------------------------------------------
% UI Callbacks
%
%--------------------------------------------------------------------------
% --------------------------------------------------------------------
    function mammo_dir_select_Callback(hObject, eventdata) %#ok
    % Callback to...
        set(ui.mammo_dir_select, 'Enable', 'off');
        temp_dir = ...
            uigetdir(mammo_dir, 'Select the directory containing the mammograms');
        if temp_dir
            mammo_dir = temp_dir;
            set(ui.mammo_dir_box, 'string', mammo_dir);
        end
        set(ui.mammo_dir_select, 'Enable', 'on');
    end
%--------------------------------------------------------------------------
    function map_dir_select_Callback(hObject, eventdata) %#ok
    % Callback to...
        set(ui.map_dir_select, 'Enable', 'off');
        temp_dir = ...
            uigetdir(map_dir, 'Select the directory containing the organisation maps');
        if temp_dir
            map_dir = temp_dir;
            set(ui.map_dir_box, 'string', map_dir);
        end
        set(ui.map_dir_select, 'Enable', 'on');
    end
%--------------------------------------------------------------------------
    function update_Callback(hObject, eventdata) %#ok
    % Callback to...
        get_pair_information;
    end    
% --------------------------------------------------------------------
    function quit_Callback(hObject, eventdata) %#ok
    % Callback executed if the user tries to quit
        
        %Check if they're ok to quit
        delete(ui.main_fig);
    end

% --------------------------------------------------------------------
    function r_max_slider_Callback(hObject, eventdata) %#ok
    % Callback...
        
    	curr_map = round(get(ui.r_max_slider, 'value'));
        update_map_axes_display;

    end

% --------------------------------------------------------------------
    function smoothing_slider_Callback(hObject, eventdata) %#ok
    % Callback...
        curr_smoothing = 2^(get(ui.smoothing_slider, 'value')-1);
        set(ui.smoothing_slider_text, 'String', ['Select map smoothing: sigma = ' num2str(curr_smoothing,1)]);
        update_map_axes_display;
    end

% --------------------------------------------------------------------
    function previous_pair_Callback(hObject, eventdata) %#ok
    % Callback to the "zoom" button allowing the user to zoom in/out the 
    % mammogram
        curr_pair = curr_pair - 1;
        update_curr_pair;
    end

% --------------------------------------------------------------------
    function next_pair_Callback(hObject, eventdata) %#ok
    % Callback to the "pan" button allowing the user to pan around the 
    % mammogram
        curr_pair = curr_pair + 1;
        update_curr_pair;
    end
% --------------------------------------------------------------------
    function pair_number_selecter_Callback(hObject, eventdata) %#ok
    % Callback...
        curr_pair = get(ui.pair_number_selecter, 'value');
        update_curr_pair;
    end
% --------------------------------------------------------------------
    function min_c_slider_Callback(hObject, eventdata) %#ok
    % Callback...
        min_slider = get(ui.min_c_slider, 'value');
        max_slider = max(min_slider+0.01, get(ui.max_c_slider, 'value'));
        
        set(ui.max_c_slider, 'value', max_slider);
        
        new_max_c = 2*max_slider - min_slider;
        new_min_c = min_slider;
        
        %Compute map limits for color scaling
        map_lim = [new_min_c new_max_c];
        
        %Compute mammo limits for color scaling
        set(ui.axes3, 'Clim', map_lim);
        set(ui.axes4, 'Clim', map_lim);
        
        set(ui.axes5,...
            'YTickLabel', num2str(linspace(min_slider, max_slider, length(get(ui.axes5, 'Ytick')))',3));
        %
        set(ui.min_c_slider_text,...
            'String', ['Select min/max value of map contrast range: [' num2str(min_slider,3) ', ' num2str(max_slider,3) ']']);
    end
% --------------------------------------------------------------------
    function max_c_slider_Callback(hObject, eventdata) %#ok
    % Callback...
        max_slider = get(ui.max_c_slider, 'value');
        min_slider = min(max_slider-0.01, get(ui.min_c_slider, 'value'));
        
        set(ui.min_c_slider, 'value', min_slider);
        
        new_max_c = 2*max_slider - min_slider;
        new_min_c = min_slider;
        
        %Compute map limits for color scaling
        map_lim = [new_min_c new_max_c];
        
        %Compute mammo limits for color scaling
        set(ui.axes3, 'Clim', map_lim);
        set(ui.axes4, 'Clim', map_lim);
        
        set(ui.axes5,...
            'YTickLabel', num2str(linspace(min_slider, max_slider, length(get(ui.axes5, 'Ytick')))',3));
        %
        set(ui.min_c_slider_text,...
            'String', ['Select min/max value of map contrast range: [' num2str(min_slider,3) ', ' num2str(max_slider,3) ']']);
    end
% --------------------------------------------------------------------
    function min_m_slider_Callback(hObject, eventdata) %#ok
    % Callback...
        min_slider = get(ui.min_m_slider, 'value');
        max_slider = max(min_slider+0.01, get(ui.max_m_slider, 'value'));
        
        set(ui.max_m_slider, 'value', max_slider);
        
        new_max_m = max_slider;
        new_min_m = 2*min_slider - max_slider;
        
        %Compute mammo limits for color scaling
        mammo_lim = [new_min_m new_max_m];
        
        %Compute mammo limits for color scaling
        set(ui.axes1, 'Clim', mammo_lim);
        set(ui.axes2, 'Clim', mammo_lim);
        
        set(ui.axes6,...
            'YTickLabel', num2str(linspace(min_slider, max_slider, length(get(ui.axes6, 'Ytick')))',3));
        
        %
        set(ui.min_m_slider_text,...
            'String', ['Select min/max value of mammogram contrast range: [' num2str(min_slider,3) ', ' num2str(max_slider,3) ']']);
    end
% --------------------------------------------------------------------
    function max_m_slider_Callback(hObject, eventdata) %#ok
    % Callback...
        max_slider = get(ui.max_m_slider, 'value');
        min_slider = min(max_slider-0.01, get(ui.min_m_slider, 'value'));
        
        set(ui.min_m_slider, 'value', min_slider);
        
        new_max_m = max_slider;
        new_min_m = 2*min_slider - max_slider;
        
        %Compute mammo limits for color scaling
        mammo_lim = [new_min_m new_max_m];
        
        %Compute mammo limits for color scaling
        set(ui.axes1, 'Clim', mammo_lim);
        set(ui.axes2, 'Clim', mammo_lim);
        
        set(ui.axes6,...
            'YTickLabel', num2str(linspace(min_slider, max_slider, length(get(ui.axes6, 'Ytick')))',3));
        
        %
        set(ui.min_m_slider_text,...
            'String', ['Select min/max value of mammogram contrast range: [' num2str(min_slider,3) ', ' num2str(max_slider,3) ']']);
    end
% --------------------------------------------------------------------
    function zoom_Callback(hObject, eventdata) %#ok
    % Callback to the "Zoom" button on the main control panel, allowing the
    % user to zoom in/out of any of 3 ROI figures (zooming occurs
    % simultaneously in all 3 figures)
        if get(ui.zoom_on, 'Value')
            set(ui.pan_on, 'Value', 0);
            axes(ui.axes1); zoom on;
            axes(ui.axes2); zoom on;
            axes(ui.axes3); zoom on;
            axes(ui.axes4); zoom on;
          
        else
            axes(ui.axes1); zoom off;
            axes(ui.axes2); zoom off;
            axes(ui.axes3); zoom off;
            axes(ui.axes4); zoom off;
            
            set(ui.region3, 'buttondownfcn', @display_hist);
            set(ui.region4, 'buttondownfcn', @display_hist);
        end
    end

    % --------------------------------------------------------------------
    function pan_Callback(hObject, eventdata) %#ok
    % Callback to the "Pan" button on the main control panel, allowing the
    % user to pan around any of 3 ROI figures (panning occurs
    % simultaneously in all 3 figures)
        if get(ui.pan_on, 'Value')
            set(ui.zoom_on, 'Value', 0);
            axes(ui.axes1); pan on;
            axes(ui.axes2); pan on;
            axes(ui.axes3); pan on;
            axes(ui.axes4); pan on;
          
        else
            axes(ui.axes1); pan off;
            axes(ui.axes2); pan off;
            axes(ui.axes3); pan off;
            axes(ui.axes4); pan off;
            
            set(ui.region3, 'buttondownfcn', @display_hist);
            set(ui.region4, 'buttondownfcn', @display_hist);
        end
    end
% --------------------------------------------------------------------
    function meta_Callback(hObject, eventdata) %#ok
    % Callback to the "Pan" button on the main control panel, allowing the
    % user to pan around any of 3 ROI figures (panning occurs
    % simultaneously in all 3 figures)
        if get(ui.meta_on, 'Value')
            set(ui.meta1, 'visible', 'on');
            set(ui.meta2, 'visible', 'on');
            set(ui.meta3, 'visible', 'on');
            set(ui.meta4, 'visible', 'on');
          
        else
            set(ui.meta1, 'visible', 'off');
            set(ui.meta2, 'visible', 'off');
            set(ui.meta3, 'visible', 'off');
            set(ui.meta4, 'visible', 'off');
        end
    end
% --------------------------------------------------------------------
    function do_max_Callback(hObject, eventdata) %#ok
    % Callback to the "Pan" button on the main control panel, allowing the
    % user to pan around any of 3 ROI figures (panning occurs
    % simultaneously in all 3 figures)
        if do_max
            do_max = 0;
            set(ui.r_max_slider, 'enable', 'on');
        else
            do_max = 1;
            set(ui.r_max_slider, 'enable', 'off');
        end
        update_map_axes_display;
    end
% --------------------------------------------------------------------
    function f1_or_f2_Callback(hObject, eventdata) %#ok
    % Callback to the "Pan" button on the main control panel, allowing the
    % user to pan around any of 3 ROI figures (panning occurs
    % simultaneously in all 3 figures)
        if f1_or_f2 == 1
            f1_or_f2 = 2;
            set(ui.f1_or_f2, 'String','Show F1');
        else
            f1_or_f2 = 1;
            set(ui.f1_or_f2, 'String','Show F2');
        end
        update_map_axes_display;
    end

% --------------------------------------------------------------------
    function display_hist(hObject, eventdata) %#ok
    %
%         g_width = round(curr_smoothing);
%         g_filt = fspecial('gaussian', 6*g_width + 1, curr_smoothing);
%         phi = linspace(0, pi, 100);
%         max_val = 0.1*max(get(ui.axes5, 'Clim'));
%         
%         if gca == ui.axes3
%             XYZ = get(ui.axes3, 'CurrentPoint');
%             x_lim = get(ui.axes3, 'Xlim');
%             y_lim = get(ui.axes3, 'Ylim');
%             x = round( size(im3, 2) * XYZ(1,1) / x_lim(2));
%             y = round( size(im3, 1) * XYZ(1,2) / y_lim(2) );
%             
%             num_angles = size(im3,3);
%             roi = scaling3*double(reshape(im3(y-3*g_width:y+3*g_width, x-3*g_width:x+3*g_width,:), [], num_angles));
%             
%         elseif gca == ui.axes4
%             XYZ = get(ui.axes4, 'CurrentPoint');
%             x_lim = get(ui.axes4, 'Xlim');
%             y_lim = get(ui.axes4, 'Ylim');
%             x = round( size(im4, 2) * XYZ(1,1) / x_lim(2) );
%             y = round( size(im4, 1) * XYZ(1,2) / y_lim(2) );
%             
%             num_angles = size(im4,3);
%             roi = scaling4*double(reshape(im4(y-3*g_width:y+3*g_width, x-3*g_width:x+3*g_width,:), [], num_angles));
%            
%             
%         else
%             display('Unknown axis caller');
%         end
% 
%         set(ui.popup_fig, 'visible', 'on');
%         axes(ui.popup_axes(ui.popup_idx));
%         hold off;
%         ui.popup_idx = mod(ui.popup_idx,2)+1;
%         
%         rad_vals = g_filt(:)' * roi;
%         [theta rho] = polar_bar([rad_vals 0 0], pi*(-1:num_angles)/num_angles);
% 
%         %Plot radial axes marker
%         plot([-max_val max_val], [0 0], 'k--'); hold on;
%         plot([0 0], [0 max_val], 'k--');
%         for ii = 2:2:10
%             plot(ii*max_val*cos(phi)/10, ii*max_val*sin(phi)/10, 'k--');
%         end
% 
%         plot(rho.*cos(theta), rho.*sin(theta)); axis equal;
%         axis([-max_val max_val min(rho.*sin(theta)) max_val]);
%         set(gca, 'xticklabel', []);
%         title(['Orientation histogram for x = ' num2str(x), ' y = ' num2str(y)]);
%         xlabel(['Sum = ' num2str(sum(rad_vals),3), ', S.D. = ' num2str(std(rad_vals),3) ', Entropy = ' num2str(mb_entropy(rad_vals),3)]);  
    end

%--------------------------------------------------------------------------
%--------------------------------------------------------------------------
%---------------------- END OF FUNCTION -----------------------------------
%--------------------------------------------------------------------------
end