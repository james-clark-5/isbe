%Sorting out data for the 2 year study

%Notes:
% Base directory on MB's local machine is C:\isbe\nailfold\data\2_year_study
% Original data stored on the network drive at "N:\musculoskeletal\NCM only studies\2 yr data incl marina mark up".  
% Images (originally in .bmp) from dir "anonymous_bmap_files1" and its sub-dir "Additional mosaics 28-03-2014" 
% converted to .png/.mat format and stored in "anonymous_png"/"images" respectively. 
% .mat images are downsized by a factor of 2
function run_ncm_batch(local_root, steps, varargin)

args = u_packargs(varargin,... % the user's input
    '0', ... % non-strict mode
    'im_idx', [],...
    'maxima_name', 'version0',...
    'prob_dir',             'rf_classification/296655/',... 296655
    'ori_dir',              'rf_regression/296621/',...
    'width_dir',            'rf_regression/297037/',...
    'fov_mask_dir',         'fov_masks/',...
    'centre_dir',           'vessel_centres/',...
    'candidates_dir',       'apex_maps\set12g_half_296655\version0\',...
    'hog_dir',              'hogs',...
    'rescore_dir',          'rescores',...
    'displacement_dir',     'displacements',...
    'selected_dir',         'selected_apexes',...
    'metrics_dir',          'apex_metrics',...
    'aam_dir',              'aam',...
    'feature_im_dir',       'images',...
    'save_dir',             'results',....
    'model_dir',            [nailfoldroot 'data/rsa_study/models/apex_templates/'],...
    'apex_class_rf',        [nailfoldroot 'models\apex\rescoring\miccai_all\rf.mat'],...        
    'class_map',            [nailfoldroot,'models/apex/final_MAP/miccai_class_MAP/class_map.mat'],...
    'aam_name',             'aam/orig/2/vessel_apex_orig.smd',...
    'xls_filename',         'all_image_auto_measures.xls',...
    'prob_sigma',           1,...
    'ori_sigma',            0,...
    'width_sigma',          1,...
    'feature_sigma',        0,...
    'num_cells',            8,...
    'cell_sz',              8,... %Size of HoG cells in blocks
    'block_sz',             [2 2],...%Size of blocks in cells
    'num_ori_bins',         12,... %Number of bins in orientation histograms
    'norm_method',          'l1-sqrt',... %Method for local normalisation
    'block_spacing',        8,... %Separation between blocks in pixels - controls level of overlap
    'gradient_operator',    [-1 0 1],...
    'spatial_sigma',        0, ...
    'angle_wrap',           1,...
    'base_width',           20, ...
    'dist_thresh',          24^2,...
    'min_candidates',       3,...
    'initial_thresh',       0.3,...
    'grid_spacing',         8,...
    'strong_vessel_thresh', 0.8,...
    'angle_discard_thresh', 75*pi/180,...
    'do_final_cull',        1,...
    'do_post_merge',        1,...
    'merge_dist_thresh',    60,...
    'merge_connect_thresh', 0.25,...
    'merge_n_pts',          20,...
    'overwrite',            0,...
    'do_aam',               0,...
    'width_predictor',      [],...[nailfoldroot 'models/apex/width/rf.mat'],...
    'do_distal',            1,...
    'do_nondistal',         1,...
    'plot',                 0,...
    'selected_features',    [],... %Do them all for now
    'plot_distal',          1,...
    'plot_nondistal',       1, ...
    'fig_dir',              [],...
    'um_per_pix',           1.25,...
    'aam_thresh',           -2e4,...
    'plot_rejected',        1,...
    'plot_r',               1,...
    'plot_c',               1);

im_names_s = dir([nailfoldroot 'data/' local_root '/images/*.mat']);
num_ims = length(im_names_s);
im_names = cell(num_ims,1);
for i_im = 1:num_ims
    im_names{i_im} = im_names_s(i_im).name(1:end-4);
end

if isempty(args.im_idx)
    args.im_idx = 1:num_ims;
end

for i_step = steps
    
    switch i_step
        
        case 1
        %% ------------------------------------------------------------------------
            extract_vessel_centres_set(...
                'data_dir', [nailfoldroot 'data\' local_root '\'],...
                'num_jobs', 1, ...
                'task_id', 1,...
                'prob_dir',             args.prob_dir,... 296655
                'ori_dir',              args.ori_dir,...
                'width_dir',            args.width_dir,...
                'fov_mask_dir',         args.fov_mask_dir,...
                'centre_dir',           args.centre_dir,...
                'prob_sigma',           args.prob_sigma,...
                'ori_sigma',            args.ori_sigma,...
                'width_sigma',          args.width_sigma,...
                'overwrite',            args.overwrite);
        %%
        %--------------------------------------------------------------------------
        %Copy data to the CSF, run apex offset predictor on CSF to compute apex
        %offset map
        % DATA_ROOT="scratch/nailfold/" MODEL_ROOT="models/apex" MODEL_PATH="set12g_half_296655" NUM_JOBS=577 IMAGE_ROOT="data/anniek" IMAGE_DIR="predictions/detection/rf_classification/296655" MASK_DIR="fov_masks" OVERWRITE=0 THRESH=0.5 MODEL_NAME="rf" MAX_SIZE=1000 qsub -V -t 1 -l twoday matlab_code/trunk/hydra/cuc/predict_apex_offsets_set.sh
        case 2

            extract_apex_map_maxima( ... % the user's input
                'image_names',          im_names(args.im_idx),...
                'data_dir',             [nailfoldroot 'data/' local_root '/'],...
                'fov_mask_dir',         'fov_masks',...
                'centre_dir',           'vessel_centres',...
                'apex_map_dir',         'apex_maps\set12g_half_296655',...
                'candidates_dir',       ['apex_maps\set12g_half_296655\' args.maxima_name],...
                'exclusion_zone',       20,...
                'transform_scores',     0,...
                'apex_class_thresh',    0.5,...
                'discard_pts',          0,...
                'base_width',           20,...
                'use_island_max',       0,...
                'island_thresh',        0,...
                'overwrite',            0);
        %%
        case 3
            compute_apex_candidate_hogs( ... % the user's input
                'image_names',          im_names(args.im_idx),...
                'data_dir',             [nailfoldroot 'data/' local_root '/'],...
                'feature_im_dir',       'images',...
                'ori_dir',              'rf_regression/296621/',...
                'width_dir',            'rf_regression/297037/',...
                'candidates_dir',       ['apex_maps\set12g_half_296655\' args.maxima_name],...
                'hog_dir',              ['apex_maps\set12g_half_296655\' args.maxima_name '\hogs'],...
                'feature_sigma',        0,...
                'prob_sigma',           2,...
                'ori_sigma',            0,...
                'width_sigma',          2,...
                'num_cells',            8,...
                'cell_sz',              8,... %Size of HoG cells in blocks
                'block_sz',             [2 2],...%Size of blocks in cells
                'num_ori_bins',         12,... %Number of bins in orientation histograms
                'norm_method',          'l1-sqrt',... %Method for local normalisation
                'block_spacing',        8,... %Separation between blocks in pixels - controls level of overlap
                'gradient_operator',    [-1 0 1],...
                'spatial_sigma',        0, ...
                'angle_wrap',           1,...
                'base_width',           20, ...
                'dist_thresh',          24^2,...
                'overwrite',            0);
        %%
        case 4
            rf = u_load('C:\isbe\nailfold\models\apex\rescoring\miccai_all\rf.mat');
            predict_apex_candidate_rescore(...
                'image_names',          im_names(args.im_idx),...
                'apex_class_rf',        rf,...
                'data_dir',             [nailfoldroot 'data/' local_root '/'],...
                'candidates_dir',       ['apex_maps\set12g_half_296655\' args.maxima_name],...
                'rescore_dir',          ['apex_maps\set12g_half_296655\' args.maxima_name '\rescores'],...
                'hog_dir',              ['apex_maps\set12g_half_296655\' args.maxima_name '\hogs']);

            compute_apex_candidate_displacements(...
                'image_names', im_names(args.im_idx),...
                'data_dir', [nailfoldroot 'data/' local_root '/'],...
                'vessel_centre_dir', 'vessel_centres',...
                'displacement_dir', ['apex_maps\set12g_half_296655\' args.maxima_name '\displacements'],...
                'candidates_dir', ['apex_maps\set12g_half_296655\' args.maxima_name '\rescores'],...
                'min_candidates', 3,...
                'initial_thresh', 0.3,...
                'grid_spacing', 8);
        %%
        case 5
            load([nailfoldroot,'models/apex/final_MAP/miccai_class_MAP/class_map.mat']);
            select_vessels_from_candidates( ...
                'image_names',          im_names(args.im_idx),...
                'data_dir', [nailfoldroot 'data/' local_root '/'],...
                'class_map',            class_map,...
                'selected_dir',         ['apex_maps\set12g_half_296655\' args.maxima_name '\selected_apexes'],...
                'displacement_dir',     ['apex_maps\set12g_half_296655\' args.maxima_name '\displacements'],...
                'rescore_dir',          ['apex_maps\set12g_half_296655\' args.maxima_name '\rescores'],...
                'strong_vessel_thresh', 0.8,...
                'angle_discard_thresh', 75*pi/180,...
                'do_final_cull',        1,...
                'do_post_merge', 1,...
                'merge_dist_thresh', 60,...
                'merge_connect_thresh', 0.25,...
                'merge_n_pts', 20);
        %%
        case 6
            extract_apex_measures_set(...
                'image_names',          im_names(args.im_idx),...
                'data_dir',             [nailfoldroot 'data/' local_root '/'],...
                'image_dir',            'images',...
                'prob_dir',             'rf_classification/296655',...
                'ori_dir',              'rf_regression/296621',...
                'width_dir',            'rf_regression/297037',...
                'candidates_dir',       ['apex_maps\set12g_half_296655\' args.maxima_name '\rescores'],...
                'displacements_dir',    ['apex_maps\set12g_half_296655\' args.maxima_name '\displacements'],...
                'selected_dir',         ['apex_maps\set12g_half_296655\' args.maxima_name '\selected_apexes'],...
                'metrics_dir',          ['apex_maps\set12g_half_296655\' args.maxima_name '\apex_metrics'],...
                'aam_dir',              'aam',...
                'do_aam',               0,...
                'model_dir',            [nailfoldroot 'data/rsa_study/models/apex_templates/'],...
                'aam_name',             'aam/orig/2/vessel_apex_orig.smd',...
                'width_predictor',      [],...[nailfoldroot 'models/apex/width/rf.mat'],...
                'prob_sigma',           2,...
                'ori_sigma',            0,...
                'width_sigma',          2,...
                'do_distal',            1,...
                'do_nondistal',         1,...
                'plot', 0);
        %%
        case 7
            results_dir = [nailfoldroot 'data/' local_root '/results/'];
            xls_filename = [results_dir 'all_image_auto_measures.xls'];

            apex_stats_to_xls([],...auto_stats,...
                'image_names',          im_names(args.im_idx),...
                'data_dir',             [nailfoldroot 'data/' local_root '/'],...
                'vessel_centre_dir',    'vessel_centres\',...
                'selected_dir',         ['apex_maps\set12g_half_296655\' args.maxima_name '\selected_apexes'],...
                'metrics_dir',          ['apex_maps\set12g_half_296655\' args.maxima_name '\apex_metrics'],...
                'selected_features', [],... %Do them all for now
                'xls_filename', xls_filename,...
                'save_dir', results_dir);
            
        case 8
            
            display_automated_markup(... % the user's input
                'image_names',          im_names(args.im_idx),...
                'data_dir',             [nailfoldroot 'data/' local_root '/'],...
                'image_dir',            'images',...
                'vessel_centre_dir',    'vessel_centres\',...
                'selected_dir',         ['apex_maps\set12g_half_296655\' args.maxima_name '\selected_apexes'],...
                'candidates_dir',       ['apex_maps\set12g_half_296655\' args.maxima_name '\rescores'],...
                'metrics_dir',          ['apex_maps\set12g_half_296655\' args.maxima_name '\apex_metrics'],...
                'selected_features', [],...
                'do_distal',        1,...
                'do_nondistal',     1, ...
                'do_people_plots',  0,...
                'fig_dir',          [],...
                'um_per_pix',       1.25,...
                'aam_thresh',       -2e4,...
                'plot_rejected',    1,...
                'plot_r', 1,...
                'plot_c', 1);
    end
end
%% ------------------------------------------------------------------------
%**************************************************************************
%**************************************************************************
%% ------------------------------------------------------------------------





   