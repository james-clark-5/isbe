%% ************************************************************************
%% Script to compute vessel detection results on the final test set of RSA images
%% ************************************************************************
%
% -------------------------------------------------------------------------
%% 1) Predicting vesselness, orientation and width for the images
% This is done on the csf, the RF names for the predictions are:
% detection: 296655
% orientation: 296621
% width: 297037

%% 2) Extract vessel centres
extract_vessel_centres_set(...
    'data_dir', 'C:\isbe\nailfold\data\rsa_study\final_test\',...
    'num_jobs', 1, 'task_id', 1,...
    'prob_dir',             'rf_classification/296655/',... 296655
    'ori_dir',              'rf_regression/296621/',...
    'width_dir',            'rf_regression/297037/',...
    'fov_mask_dir',         'fov_masks/',...
    'centre_dir',           'vessel_centres/',...
    'prob_sigma',           1,...
    'ori_sigma',            0,...
    'width_sigma',          1,...
    'overwrite',            0);
%% 3) Predictthe location of vessel apexes
%Again use CSF, using the model set12g_half_296655

%% 4) Update the offset maps and extract local maxima
im_list = dir('C:\isbe\nailfold\data\rsa_study\final_test\images\*.mat');

apex_map_dir = 'C:\isbe\nailfold\data\rsa_study\final_test\apex_maps\set12g_half_296655\';
fov_mask_dir = 'C:\isbe\nailfold\data\rsa_study\final_test\fov_masks\';
vessel_centres_dir = 'C:\isbe\nailfold\data\rsa_study\final_test\vessel_centres\';
create_folder([apex_map_dir 'mixed_maxima']);

exclsuion_zone = 20;
apex_class_thresh = 0.5;
base_width = 20;

for i_im = 1:length(im_list);
    im_name = im_list(i_im).name(1:6);
    display(['Processing image ' num2str(i_im) ', ' datestr(now)]);
    
    load([apex_map_dir im_name '_pred.mat']);
    load([vessel_centres_dir im_name '_vc.mat']);
    f_mask = u_load([fov_mask_dir im_name '_f_mask.mat']);
    
    [discard_pts] = discard_edge_preds(vessel_centre, f_mask);
    include_pts = ~discard_pts & (apex_class_pred > apex_class_thresh);
    
    [apex_offset_map] = ...
        transform_apex_offset_preds(apex_class_pred, apex_offset_x_pred, apex_offset_y_pred,...
            vessel_centre, nrows, ncols, base_width, include_pts);
        
    [candidate_xy candidate_scores] = ...
        local_image_maxima(apex_offset_map, exclsuion_zone, f_mask, 0);
    
    save([apex_map_dir 'mixed_maxima\' im_name '_candidates'],...
        'candidate_xy', 'candidate_scores');
end
%% 5) Compute the midline of the test images
compute_mosiac_midline_set(...
    'C:\isbe\nailfold\data\rsa_study\final_test\fov_masks\', ...
    'C:\isbe\nailfold\data\rsa_study\final_test\image_rotations\',...
    'start_i', 1, 'end_i', [],...
    'resize_factor', 4, 'min_depth', 235, 'edge_ori_sigma', 8);

%% 6) Apply spatial criteria to select which local maxima to keep
select_vessels_from_candidates_set('start_i', 1, 'end_i', [],...
    'do_fill_gaps', 0, 'do_distal_sub', 0, 'do_save', 1, 'do_plot', 0,...
    'data_dir', 'C:\isbe\nailfold\data\rsa_study\final_test\',...
    'candidates_dir', 'apex_maps\set12g_half_296655\mixed_maxima\',...
    'input_dir', 'apex_maps\set12g_half_296655\mixed_maxima\',...
    'output_dir', 'apex_maps\set12g_half_296655\mixed_maxima\selected_candidates\',...
    'upper_ydist', -70,...
    'lower_ydist', 45);
%% 7) Make a results structure
apex_gt_dir = [nailfoldroot 'data/rsa_study/final_test/apex_gt/'];
candidate_dir = [nailfoldroot 'data\rsa_study\final_test\apex_maps\set12g_half_296655\mixed_maxima\selected_candidates\'];

apex_gt_list = dir([apex_gt_dir '*.mat']);
candidate_list = dir([candidate_dir '*.mat']);

apex_gt_cell = cell(length(apex_gt_list),1);
for ii = 1:length(apex_gt_list)
    apex_gt_cell{ii} = apex_gt_list(ii).name(1:6);
end
candidate_cell = cell(length(candidate_list),1);
for ii = 1:length(candidate_list)
    candidate_cell{ii} = candidate_list(ii).name(1:6);
end
selected_candidates = find(ismember(candidate_cell, apex_gt_cell));

mkdir([nailfoldroot 'data/rsa_study/final_test/results/']); 
make_detection_results_struc(...
    'results_name', 'detection_results', ...
    'candidates_dir',    candidate_dir,... %mandatory arguments
    'apex_gt_dir', apex_gt_dir,...
    'results_dir', [candidate_dir 'results\'],...
    'prob_dir', [nailfoldroot 'data/rsa_study/final_test/predictions/detection/rf_classification/296655/'],...
    'selected_gt', [],...
    'selected_candidates', selected_candidates,...
    'selected_prob', selected_candidates);

%% 8) Ok, here goes nothing....
final_results = analyse_detection_results(...
    'results_name', 'detection_results',... rf_offset_half_20131210T123607
    'candidates_dir',    candidate_dir,... %mandatory arguments
    'apex_gt_dir', [nailfoldroot 'data/rsa_study/final_test/apex_gt/'],...
    'results_dir', [candidate_dir 'results\'],...
    'selected_images', [],...
    'use_only_gradeable', 0,...
    'min_num_markers', 1,...
    'max_missing_markers', inf,...
    'overall_summary', 1,...
    'summary_by_grade', 0,...
    'summary_by_shape', 0,...
    'summary_by_size', 0,...
    'compute_rocs', 0,...
    'analysis_by_width', 0,...
    'fixed_counting', 0,...
    'pct_counting', 0,...
    'perfect_counting', 0,...
    'final_selection', 1,...
    'intermediate_selection', 0);

%% 9)
extract_apex_measures_set(...
        'data_dir', 'C:\isbe\nailfold\data\rsa_study\test_half\',...
        'num_jobs', 1, 'task_id', 1,...
        'prob_dir',             'rf_classification/296655/',...
        'ori_dir',              'rf_regression/296621/',...
        'width_dir',            'rf_regression/297037/',...
        'candidates_dir',       'apex_maps\set12g_half_296655\mixed_maxima',...
        'fov_mask_dir',         'fov_masks/',...
        'prob_sigma',           1,...
        'ori_sigma',            0,...
        'width_sigma',          1,...
        'plot', 0);
extract_apex_measures_set(...
        'data_dir', 'C:\isbe\nailfold\data\rsa_study\final_test\',...
        'num_jobs', 1, 'task_id', 1,...
        'prob_dir',             'rf_classification/296655/',...
        'ori_dir',              'rf_regression/296621/',...
        'width_dir',            'rf_regression/297037/',...
        'candidates_dir',       'apex_maps\set12g_half_296655\mixed_maxima',...
        'fov_mask_dir',         'fov_masks/',...
        'prob_sigma',           1,...
        'ori_sigma',            0,...
        'width_sigma',          1,...
        'plot', 0);